name: Deploy Swagger Documentation to GitHub Pages

# Запускать только при влитии (merge) PR в main
on:
  pull_request:
    types: [closed]
    branches:
      - main
  # Возможность запустить вручную из интерфейса GitHub
  workflow_dispatch:

# Разрешения для публикации на GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Разрешить только один concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    # Выполнять при ручном запуске или при слиянии PR в main (не при простом закрытии)
    if: github.event_name == 'workflow_dispatch' || (github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Pages
        uses: actions/configure-pages@v5
      
      - name: Create docs directory
        run: |
          mkdir -p _site
          cp service2110/docs/swagger/swagger.json _site/swagger.json
      
      - name: Generate Swagger HTML
        run: |
          cat > _site/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="ru">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>API Documentation - Service 2110</title>
              <link rel="stylesheet" type="text/css" href="https://unpkg.com/swagger-ui-dist@5.31.0/swagger-ui.css">
              <style>
                  html { box-sizing: border-box; overflow-y: scroll; }
                  *, *:before, *:after { box-sizing: inherit; }
                  body { margin: 0; padding: 0; }
                  .topbar { display: none; }
                  .theme-toggle-btn {
                      position: fixed; top: 10px; right: 10px; z-index: 9999;
                      padding: 8px 14px; border-radius: 8px; cursor: pointer;
                      font-size: 13px; font-family: inherit; box-shadow: 0 1px 3px rgba(0,0,0,.2);
                      border: 1px solid rgba(255,255,255,.2); background: rgba(0,0,0,.15); color: inherit;
                  }
                  .theme-toggle-btn:hover { background: rgba(0,0,0,.25); }
                  html:not(.dark-mode) .theme-toggle-btn {
                      border-color: rgba(0,0,0,.2); background: rgba(0,0,0,.06);
                  }
                  html:not(.dark-mode) .theme-toggle-btn:hover { background: rgba(0,0,0,.1); }
              </style>
          </head>
          <body>
              <div id="swagger-ui"></div>
              <script>
                  (function() {
                      var key = 'swagger-ui-theme';
                      var isDark = localStorage.getItem(key) !== 'light';
                      document.documentElement.classList.toggle('dark-mode', isDark);
                  })();
              </script>
              <script src="https://unpkg.com/swagger-ui-dist@5.31.0/swagger-ui-bundle.js"></script>
              <script src="https://unpkg.com/swagger-ui-dist@5.31.0/swagger-ui-standalone-preset.js"></script>
              <script>
                  window.onload = function() {
                      window.ui = SwaggerUIBundle({
                          url: "./swagger.json",
                          dom_id: '#swagger-ui',
                          deepLinking: true,
                          presets: [
                              SwaggerUIBundle.presets.apis,
                              SwaggerUIStandalonePreset
                          ],
                          plugins: [
                              SwaggerUIBundle.plugins.DownloadUrl
                          ],
                          layout: "StandaloneLayout",
                          tryItOutEnabled: false,
                          displayRequestDuration: true,
                          filter: true,
                          syntaxHighlight: { activate: true, theme: "monokai" }
                      });
                      var key = 'swagger-ui-theme';
                      function updateBtn() {
                          var dark = document.documentElement.classList.contains('dark-mode');
                          btn.textContent = dark ? 'Светлая тема' : 'Тёмная тема';
                      }
                      var btn = document.createElement('button');
                      btn.type = 'button';
                      btn.className = 'theme-toggle-btn';
                      updateBtn();
                      btn.onclick = function() {
                          document.documentElement.classList.toggle('dark-mode');
                          localStorage.setItem(key, document.documentElement.classList.contains('dark-mode') ? 'dark' : 'light');
                          updateBtn();
                      };
                      document.body.appendChild(btn);
                  };
              </script>
          </body>
          </html>
          EOF
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
