# AI Tasks Runner

Скрипт автоматизации выполнения заданий из манифеста с запуском агентов (выполнение, проверка, актуализация) и фиксацией в git.

## Назначение

- Читает список заданий из `docs/tasks/tasks-manifest.json`.
- Для каждой задачи (со статусом `planned` или по списку id): создаёт ветку, до 5 попыток выполнения, после каждой попытки — проверка, коммит.
- При успешной проверке запускает агента актуализации, коммит, push.
- При неудаче за 5 попыток — запись лога остановки, push, выход.
- Логи агентов сохраняются в `docs/logs/`.

## Запуск

Из корня репозитория:

```bash
node scripts/ai-tasks-runner/runner.js
```

Или через npm (если добавлен скрипт):

```bash
npm run ai-tasks:run
```

### Аргументы

| Аргумент | Описание |
|----------|----------|
| `--dry-run` | Вывести список задач и веток без запуска агентов и коммитов |
| `--config путь` | Путь к JSON-конфигу (относительно корня репо) |
| `--task-ids id1,id2` | Выполнить только задачи с указанными id |
| `--start-from id` | Начать с задачи с указанным id (предыдущие пропустить) |
| `--no-push` | Не выполнять push после задания |
| `--no-pull` | Не выполнять pull базовой ветки в начале |

### Переменные окружения и корневой `.env`

Скрипт при старте загружает переменные из **корневого `.env`** репозитория (файл `.env` в корне репо). Все параметры конфигурации можно задать там с префиксом `AI_TASKS_` — они переопределяют значения из `config.default.json` и из файла конфига (если указан `--config`).

| Переменная | Описание |
|------------|----------|
| `AI_TASKS_CONFIG` | Путь к JSON-конфигу (если не задан `--config`) |
| `AI_TASKS_MANIFEST_PATH` | Путь к манифесту (напр. `docs/tasks/tasks-manifest.json`) |
| `AI_TASKS_TASKS_DIR` | Папка документов задач (напр. `docs/tasks`) |
| `AI_TASKS_LOGS_DIR` | Папка логов (напр. `docs/logs`) |
| `AI_TASKS_BASE_BRANCH` | Базовая ветка (напр. `main`) |
| `AI_TASKS_BRANCH_TEMPLATE` | Шаблон ветки (напр. `feature/{{id}}-{{slug}}`) |
| `AI_TASKS_MAX_ATTEMPTS` | Максимум попыток на задание (число) |
| `AI_TASKS_STATUS_FILTER` | Фильтр по статусу в манифесте (напр. `planned`) |
| `AI_TASKS_COMMIT_LOGS` | Коммитить ли логи (`true`/`false`) |
| `AI_TASKS_EMPTY_COMMIT_IF_NO_CHANGES` | Пустой коммит при отсутствии изменений (`true`/`false`) |
| `AI_TASKS_REMOTE` | Имя remote для push (напр. `origin`) |
| `AI_TASKS_EXEC_CMD` | Команда запуска агента выполнения (строка: команда + аргументы) |
| `AI_TASKS_VERIFY_CMD` | Команда запуска агента проверки |
| `AI_TASKS_ACTUALIZE_CMD` | Команда запуска агента актуализации |

Переменные команд агентов (`*_CMD`) задаются одной строкой: первый токен — команда, остальное — аргументы. Они переопределяют `execAgent`/`verifyAgent`/`actualizeAgent` из конфига.

Полный список поддерживаемых параметров с комментариями: **`scripts/ai-tasks-runner/env.example`**. Для корня репо можно скопировать его в `.env.example`: `cp scripts/ai-tasks-runner/env.example .env.example`.

Пример фрагмента корневого `.env`:

```env
AI_TASKS_BASE_BRANCH=main
AI_TASKS_LOGS_DIR=docs/logs
AI_TASKS_COMMIT_LOGS=true
AI_TASKS_EXEC_CMD=node scripts/ai-tasks-runner/agents/exec-stub.js
```

## Конфигурация

Файл по умолчанию: `scripts/ai-tasks-runner/config.default.json`.

Основные поля:

- **manifestPath** — путь к манифесту от корня репо (по умолчанию `docs/tasks/tasks-manifest.json`).
- **logsDir** — папка логов (по умолчанию `docs/logs/`).
- **baseBranch** — базовая ветка для создания веток заданий (по умолчанию `main`).
- **branchTemplate** — шаблон имени ветки: `feature/{{id}}-{{slug}}` (slug из имени файла задачи).
- **maxAttempts** — максимум попыток на задание (5).
- **statusFilter** — фильтр по статусу в манифесте (`planned` — только запланированные).
- **commitLogs** — коммитить ли файлы логов из `docs/logs/` (true/false).
- **emptyCommitIfNoChanges** — делать ли пустой коммит, если после шага нет изменений.
- **remote** — имя remote для push (по умолчанию `origin`).
- **execAgent**, **verifyAgent**, **actualizeAgent** — объекты `{ command, args }` для запуска агентов (по умолчанию — заглушки в `agents/`).

## Запуск агентов

- **Агент выполнения (exec)** — по ТЗ это агент IDE Cursor. В конфиге по умолчанию указана заглушка `agents/exec-stub.js`. Для реального запуска Cursor в headless/ночном режиме нужно задать команду в конфиге или в `AI_TASKS_EXEC_CMD` (см. документацию Cursor CLI/API).
- **Агент проверки (verify)** — запускается после каждой попытки; выход 0 = задание решено верно. Должен при необходимости дописывать в конец документа задачи блок проверки (дата, номер попытки, успех/неуспех, доработки).
- **Агент актуализации (actualize)** — запускается после успешной проверки; обновляет документ задачи и манифест (status, completedDate, branch).

Передаваемые в окружение агентов переменные: `TASK_ID`, `TASK_FILE`, `TASK_PATH`, `REPO_ROOT`, `ATTEMPT`, `LOG_PATH`; для actualize также `MANIFEST_PATH`, `BRANCH_NAME`.

## Формат имён логов

В `docs/logs/`:

- `{названиеЗадания}-{дата}-attempt-{N}-exec-log.md`
- `{названиеЗадания}-{дата}-attempt-{N}-verify-log.md`
- `{названиеЗадания}-{дата}-actualize-log.md`
- `{названиеЗадания}-{дата}-stop-log.md` (при остановке после 5 неудач)

Дата в формате `2026-01-30T12-00-00`.

## Идемпотентность

- Задачи со статусом `completed` в манифесте пропускаются.
- При повторном запуске уже выполненные задачи не перезапускаются (обрабатываются только отфильтрованные по статусу или по списку id).

## Связанные документы

- Описание задачи: `docs/tasks/TASK-021-automation-script-ai-tasks-runner.md`
- Манифест заданий: `docs/tasks/tasks-manifest.json`
