# TASK-041: Восстановление табов на детальной странице отчёта

**Статус**: ✅ Выполнено  
**Ветка**: `feature/TASK-041-restore-tabs-report-detail`

---

## Краткое описание

Восстановить табы на детальной странице отчёта, которые пропали в коммите `56c6a796829bf2fe33f010bc9b1e31b06638cfd4`.

---

## Исходное описание задачи

> Данный раздел содержит оригинальное описание задачи для оперативного обращения.

**Источник:** [Заметки от 05.02.2026](../temp-private-2110/docs/notes/2026-02-05.md#восстановить-табы-на-детальной-странице-отчёта-тарас)

```
Табы пропали в коммите `56c6a796829bf2fe33f010bc9b1e31b06638cfd4`
```

---

## Цели

- Восстановить функциональность табов на детальной странице отчёта
- Проанализировать изменения в указанном коммите
- Восстановить корректное отображение табов

---

## Детальное описание

### Контекст

В коммите `56c6a796829bf2fe33f010bc9b1e31b06638cfd4` была удалена или изменена функциональность табов на детальной странице отчёта. Необходимо восстановить их работу.

### Требования

#### Анализ коммита

1. Изучить изменения в коммите `56c6a796829bf2fe33f010bc9b1e31b06638cfd4`
2. Определить, что именно было удалено или изменено
3. Понять причину удаления табов

#### Восстановление табов

1. Восстановить структуру табов на детальной странице отчёта
2. Обеспечить корректное отображение всех табов
3. Проверить функциональность каждого таба

---

## Критерии приёмки

- [x] Проанализирован коммит `56c6a796829bf2fe33f010bc9b1e31b06638cfd4`
- [x] Определена причина исчезновения табов
- [x] Восстановлена структура табов на детальной странице отчёта
- [x] Все табы отображаются корректно
- [x] Функциональность каждого таба работает
- [x] Протестирована работа табов

---

## Порядок выполнения

1. ✅ Изучен коммит `56c6a796829bf2fe33f010bc9b1e31b06638cfd4`
2. ✅ Определены изменения, которые привели к исчезновению табов (удаление компонента `ReportDetailCardAppRouter`)
3. ✅ Восстановлен код табов на основе коммита `b27c512` с адаптацией под новое API
4. ✅ Протестирована восстановленная функциональность
5. ✅ Убедились, что все табы работают корректно
6. ✅ Выполнена миграция на новое API для всех компонентов детальной страницы
7. ✅ Добавлены моки для новых endpoints

---

## Связанные документы

- [Заметки от 05.02.2026](../temp-private-2110/docs/notes/2026-02-05.md)
- Коммит: `56c6a796829bf2fe33f010bc9b1e31b06638cfd4`

---

## Выполненные изменения

### 1. Восстановление табов на детальной странице отчёта

#### 1.1. Создан файл констант табов (`ReportDetailCard.constants.ts`):
   - Определены три таба: "Дополнительные параметры", "Список файлов", "История статусов"
   - Создан enum `ReportDetailsTabs` для типизации табов
   - Определён массив `REPORT_DETAILS_TABS` с конфигурацией табов

#### 1.2. Создан компонент табов (`ReportDetailCardTabMenu.tsx`):
   - Реализована логика переключения между табами с использованием состояния
   - Добавлена интеграция с API для получения истории статусов (`useGetTaskStatusHistoryQuery`)
   - Реализован маппинг статусов из нового API (`ReportTaskStatusEnumSchema`) в формат старого компонента (`ReportStatus`)
   - Компонент принимает `reportId` и `taskDetails` как пропсы

#### 1.3. Обновлён компонент дополнительных параметров (`ReportDetailsAdditional.tsx`):
   - Адаптирован для работы с новым API (`TaskDetailsDto`)
   - Использует данные из `taskDetails` вместо старого `reportDetails`
   - Обновлена работа с источниками через новый API (`useGetSourcesQuery`)
   - Отображает: валюту, тип, источник, счета, маску счетов, счета 2-го порядка

#### 1.4. Интегрированы табы в ReportDetailCard:
   - Табы добавлены в конец карточки детальной информации
   - Передаются необходимые пропсы (`reportId`, `taskDetails`)

### 2. Миграция на новое API

#### 2.1. Обновлён компонент списка файлов (`ReportDetailsFilesList.tsx`):
   - Заменено старое API (`API.Report.GetReportFilesService.getReportFiles`) на новое (`useGetTaskFilesQuery`)
   - Реализован маппинг `TaskFileDto` в `ReportFilesTableRow`
   - Добавлена поддержка пагинации, фильтрации и сортировки на бэкенде
   - Обновлено отображение размера файла (используются реальные данные из API в МБ)
   - Обновлена ссылка для скачивания (используется `downloadUrl` из нового API)
   - Маппинг статусов файлов: `PENDING` → `IN_QUEUE`, `CONVERTING` → `IN_PROGRESS`, `COMPLETED` → `DONE`, `FAILED` → `FAILED`

#### 2.2. Добавлены API endpoints в `report6406Api2.ts`:
   - `getTaskStatusHistory` - для получения истории статусов задания
   - `getTaskFiles` - для получения списка файлов задания с поддержкой пагинации, сортировки и фильтрации

### 3. Добавлены моки для новых endpoints

#### 3.1. Создан обработчик для файлов задания (`handlerGetTaskFiles.ts`):
   - Поддержка пагинации через параметры `number` и `size`
   - Поддержка сортировки по полям: `status`, `fileName`, `fileSize`, `createdAt`
   - Поддержка направления сортировки: `ASC`, `DESC`
   - Поддержка фильтрации по статусу файла (массив статусов)
   - Корректная обработка типизации (приведение строковых статусов из моков к enum)

#### 3.2. Создан обработчик для истории статусов (`handlerGetTaskStatusHistory.ts`):
   - Простая структура: возвращает массив элементов истории статусов
   - Использует данные из `mockData_statusHistory`
   - Возвращает пустой массив, если истории нет

#### 3.3. Зарегистрированы маршруты в `routesApi2.ts`:
   - `/api/v1/report-6406/tasks/:id/files` - GET запрос для получения файлов
   - `/api/v1/report-6406/tasks/:id/status-history` - GET запрос для получения истории статусов
   - Маршруты зарегистрированы перед более общими маршрутами для корректной обработки Express

### 4. Технические детали

- Все компоненты используют новый API из `storeAppRouter/api/report6406Api2`
- Реализована корректная типизация с учётом различий между старым и новым API
- Обеспечена обратная совместимость через маппинг данных
- Все изменения протестированы и компилируются без ошибок TypeScript
