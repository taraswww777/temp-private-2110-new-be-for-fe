# TASK-057: Доработки интеграции YouTrack (TASK-035 / TASK-036)

**Статус**: ✅ Выполнено  
**Ветка**: `feature/TASK-057-youtrack-integration-follow-up` (или текущая ветка YouTrack)

---

## Краткое описание

Провести недостающие доработки интеграции Task Viewer с YouTrack после выполнения TASK-035 (Backend) и TASK-036 (Frontend): тестирование, предпросмотр задачи при связывании, предпросмотр шаблона и переопределение полей при создании задачи, исправление мелких багов и удаление неиспользуемого кода. Добавить функционал тегов для задач с поддержкой чёрного списка тегов, которые не отправляются в YouTrack.

---

## Контекст

В рамках TASK-035 и TASK-036 реализованы создание задач в YouTrack, связывание с локальными задачами, очередь операций, управление шаблонами и базовый UI. При анализе кода выявлены пункты из критериев приёмки, оставшиеся невыполненными, а также возможности улучшить UX и качество кода.

---

## Цели

- Закрыть недостающие критерии приёмки TASK-035 (тесты, консистентность API).
- Реализовать недостающий UX из TASK-036: предпросмотр задачи при связывании, предпросмотр шаблона и переопределение полей при создании.
- Исправить выявленные недочёты в логике очереди и ответах API.
- Удалить неиспользуемый код и привести API клиент в соответствие с возможностями бэкенда.
- Добавить функционал тегов для задач: хранение тегов в манифесте, фильтрация тегов по чёрному списку при отправке в YouTrack, страница управления тегами.

---

## Детальное описание

### 1. Backend (TASK-035)

#### 1.1 Тестирование

В TASK-035 в критериях приёмки заявлены unit-тесты, которых в репозитории нет:

- Unit-тесты для YouTrack API клиента (с моками `fetch` / YouTrack ответов).
- Unit-тесты для сервисов работы с шаблонами (`templates.service`).
- Unit-тесты для сервисов работы со связями (`youtrack-links.service`).
- Unit-тесты для сервиса очереди операций (`youtrack-queue.service`, `youtrack-processor.service`).

**Задача:** добавить перечисленные тесты в `taskViewerBe` (например, в `src/**/*.test.ts` или `tests/`), используя моки для внешних вызовов и файловой системы при необходимости.

#### 1.2 Endpoint для получения информации о задаче YouTrack

Для диалога «Связать с существующей задачей» на фронте нужен предпросмотр задачи по введённому ID (summary, state, priority). Сейчас бэкенд не предоставляет публичный endpoint для получения одной задачи по ID.

**Задача:** добавить endpoint `GET /api/youtrack/issues/:youtrackIssueId`, который возвращает информацию о задаче в YouTrack (прокси к YouTrack API). Ответ должен содержать поля, достаточные для отображения предпросмотра (например: `summary`, `state`, `priority`, при необходимости `idReadable`). При недоступности YouTrack или отсутствии задачи возвращать соответствующие коды (503 / 404).

#### 1.3 Консистентность ответов при постановке в очередь

При постановке операции связывания в очередь (`POST /api/youtrack/tasks/:taskId/link`) в ответе возвращается `youtrackIssueIds: []`. Корректнее возвращать текущий список связей задачи (`youtrackIssueIds` из манифеста), чтобы контракт совпадал с ответом при немедленном выполнении.

**Задача:** при ответе с `queued: true` для `link` подставлять в `youtrackIssueIds` текущее значение из задачи (как при create), а не пустой массив.

#### 1.4 Счётчик попыток в очереди

В `youtrack-queue.service.ts` метод `updateOperationStatus` увеличивает `attempts` при каждом вызове, в том числе при успешном завершении (`status: 'completed'`). В результате у успешно выполненных операций счётчик попыток тоже увеличивается, что искажает смысл поля (попытки до успеха / до перехода в failed).

**Задача:** увеличивать `attempts` только при переходе в статус `failed` или при повторной попытке (оставлении в `pending` после ошибки). При успешном завершении (`completed`) счётчик не увеличивать.

#### 1.5 Функционал тегов для задач

Добавить поддержку тегов для задач с возможностью фильтрации при отправке в YouTrack.

**Хранение тегов:**
- Добавить опциональное поле `tags` (массив строк) в схему задачи в манифесте (`tasks-manifest.json`).
- Обновить Zod схему и TypeScript типы для поддержки `tags`.
- Теги хранятся на уровне задачи в манифесте.

**Чёрный список тегов:**
- Создать конфигурационный файл для чёрного списка тегов (например, `docs/tasks/youtrack-tags-blacklist.json`).
- Структура: `{ "blacklist": ["tag1", "tag2", ...] }` (массив строк).
- Теги из чёрного списка не отправляются в YouTrack при создании задачи.

**API для управления чёрным списком:**
- `GET /api/youtrack/tags/blacklist` — получить текущий чёрный список.
- `POST /api/youtrack/tags/blacklist` — обновить чёрный список (полная замена).
- `PUT /api/youtrack/tags/blacklist` — добавить тег в чёрный список (если его нет).
- `DELETE /api/youtrack/tags/blacklist/:tag` — удалить тег из чёрного списка.

**Фильтрация при создании задачи в YouTrack:**
- При создании задачи в YouTrack (`POST /api/youtrack/tasks`) фильтровать теги задачи: исключать теги из чёрного списка.
- Отфильтрованные теги передавать в YouTrack (если YouTrack API поддерживает теги как кастомное поле или в описании).

**Задача:** реализовать хранение тегов в манифесте, API для управления чёрным списком, фильтрацию тегов при создании задачи в YouTrack.

---

### 2. Frontend (TASK-036)

#### 2.1 Предпросмотр задачи при связывании

В TASK-036 для диалога связывания с существующей задачей указано: «Валидация существования задачи в YouTrack», «Отображение информации о задаче перед связыванием».

**Задача:** во вкладке «Связать с существующей» в `YouTrackConnectDialog` после ввода валидного ID (по формату и при успешном ответе API) запрашивать с бэкенда данные задачи (через новый `GET /api/youtrack/issues/:id`) и показывать блок предпросмотра: summary, state, priority (и при необходимости ссылку «Открыть в YouTrack»). До получения ответа показывать состояние загрузки; при ошибке (задача не найдена, YouTrack недоступен) — сообщение об ошибке.

#### 2.2 Предпросмотр шаблона при создании задачи

В TASK-036 для создания задачи в YouTrack указаны «Предпросмотр шаблона (как будет выглядеть задача)» и «Подсказки с доступными переменными».

**Задача:** на вкладке «Создать задачу в YouTrack» в `YouTrackConnectDialog` добавить компонент предпросмотра шаблона (аналогично `TemplatePreview` в `TemplateFormDialog`). Использовать данные текущей локальной задачи (taskId, title, content, status, branch), передавая их в диалог с детальной страницы или из контекста списка задач. Подсказки по переменным можно вынести в общий фрагмент или отображать под полями, как в форме шаблона.

#### 2.3 Переопределение кастомных полей при создании

В TASK-036 указано: «Опциональное переопределение кастомных полей», «Приоритет (опционально, переопределение)», «Исполнитель (опционально, переопределение)».

**Задача:** на вкладке «Создать задачу в YouTrack» добавить опциональные поля для переопределения (например, приоритет, исполнитель и при необходимости другие кастомные поля из выбранного шаблона). Передавать выбранные значения в `youtrackApi.createIssue(taskId, templateId, customFields)`. UI может быть упрощённым (например, приоритет и исполнитель как опциональные селекты/инпуты), с возможностью расширения под другие поля шаблона позже.

#### 2.4 API клиент: getIssueInfo

В `youtrack.api.ts` метод `getIssueInfo` объявлен в типах, но реализация бросает ошибку («Use getIssueLinks instead»). После появления `GET /api/youtrack/issues/:id` на бэкенде этот метод должен вызывать новый endpoint и возвращать данные задачи. Если метод не планируется использовать вне предпросмотра при связывании, можно оставить один метод вида `getIssueInfo(youtrackIssueId: string)` и использовать его только в диалоге связывания.

**Задача:** реализовать `getIssueInfo(youtrackIssueId: string)` через `GET /api/youtrack/issues/:youtrackIssueId`, вернуть типизированный ответ (summary, state, priority и т.д.) и использовать его в предпросмотре при связывании.

#### 2.5 Удаление неиспользуемого кода

Компонент `CreateYouTrackIssueDialog.tsx` нигде не импортируется; везде используется единый `YouTrackConnectDialog`.

**Задача:** удалить файл `CreateYouTrackIssueDialog.tsx`, если по результатам ревью он не нужен для других сценариев.

#### 2.6 Управление тегами задач

Добавить UI для управления тегами задач и чёрным списком тегов.

**Отображение тегов в задачах:**
- В списке задач (`TaskList.tsx`) отображать теги задачи (если есть).
- На детальной странице задачи (`TaskDetailPage.tsx`) отображать теги и возможность их редактирования.
- Теги отображать как Badge/Pill компоненты.

**Редактирование тегов задачи:**
- На детальной странице задачи добавить возможность добавлять/удалять теги.
- UI: поле ввода с автодополнением (или простой ввод через запятую) и список текущих тегов с возможностью удаления.
- При сохранении обновлять манифест через API (`PATCH /api/tasks/:id` с полем `tags`).

**Страница управления чёрным списком тегов:**
- Создать страницу `YouTrackTagsBlacklistPage.tsx` (роут `/youtrack/tags/blacklist`).
- Отображать текущий чёрный список тегов.
- Возможность добавлять тег в чёрный список (ввод + кнопка "Добавить").
- Возможность удалять тег из чёрного списка (кнопка удаления рядом с каждым тегом).
- Возможность загрузить список тегов из всех задач для удобного выбора (опционально).
- Использовать `PageHeader` для единообразия с другими страницами.

**API клиент:**
- Добавить методы в `youtrack.api.ts`:
  - `getTagsBlacklist()` — получить чёрный список.
  - `updateTagsBlacklist(blacklist: string[])` — обновить чёрный список.
  - `addTagToBlacklist(tag: string)` — добавить тег.
  - `removeTagFromBlacklist(tag: string)` — удалить тег.

**Навигация:**
- Добавить ссылку на страницу управления чёрным списком в меню/шапку (рядом с "Шаблоны YouTrack" и "Очередь YouTrack").

**Задача:** реализовать отображение и редактирование тегов в задачах, страницу управления чёрным списком тегов, API клиент для работы с чёрным списком.

---

## Критерии приёмки

### Backend
- [ ] Добавлены unit-тесты для YouTrack API клиента (моки).
- [ ] Добавлены unit-тесты для сервисов шаблонов, связей и очереди (и процессора очереди).
- [ ] Реализован `GET /api/youtrack/issues/:youtrackIssueId` с возвратом данных задачи для предпросмотра.
- [ ] При постановке операции link в очередь в ответе возвращаются актуальные `youtrackIssueIds` задачи.
- [ ] Счётчик `attempts` в очереди увеличивается только при ошибке/повторной попытке, не при успешном `completed`.
- [ ] Добавлено поле `tags` (массив строк) в схему задачи в манифесте и обновлены типы.
- [ ] Реализован сервис для работы с чёрным списком тегов (хранение в файле).
- [ ] Реализованы API endpoints для управления чёрным списком тегов (GET, POST, PUT, DELETE).
- [ ] При создании задачи в YouTrack теги фильтруются по чёрному списку (исключаются теги из чёрного списка).
- [ ] Отфильтрованные теги передаются в YouTrack при создании задачи.

### Frontend
- [ ] Во вкладке «Связать с существующей» отображается предпросмотр задачи YouTrack после ввода валидного ID.
- [ ] Во вкладке «Создать задачу в YouTrack» отображается предпросмотр шаблона с подстановкой переменных текущей задачи.
- [ ] Реализовано опциональное переопределение кастомных полей (как минимум приоритет, исполнитель) при создании задачи.
- [ ] В API клиенте реализован `getIssueInfo` через новый endpoint.
- [ ] Удалён неиспользуемый компонент `CreateYouTrackIssueDialog.tsx` (или обосновано его сохранение).
- [ ] Теги отображаются в списке задач и на детальной странице задачи.
- [ ] Реализовано редактирование тегов на детальной странице задачи (добавление/удаление).
- [ ] Создана страница управления чёрным списком тегов (`YouTrackTagsBlacklistPage`).
- [ ] На странице чёрного списка реализованы операции: просмотр, добавление, удаление тегов.
- [ ] Добавлены методы в API клиент для работы с чёрным списком тегов.
- [ ] Добавлена навигация на страницу управления чёрным списком (в меню/шапку).

### Общее
- [ ] Существующий сценарий создания/связывания/очереди продолжает работать; регрессий нет.

---

## Порядок выполнения

1. **Backend: endpoint и логика**
   - Добавить `GET /api/youtrack/issues/:youtrackIssueId`.
   - Исправить ответ при постановке link в очередь (`youtrackIssueIds`).
   - Исправить увеличение `attempts` в очереди.

2. **Backend: функционал тегов**
   - Добавить поле `tags` в схему задачи (Zod, TypeScript типы).
   - Создать сервис для работы с чёрным списком тегов (файл `docs/tasks/youtrack-tags-blacklist.json`).
   - Реализовать API endpoints для управления чёрным списком (GET, POST, PUT, DELETE).
   - Добавить фильтрацию тегов по чёрному списку при создании задачи в YouTrack.
   - Обновить `PATCH /api/tasks/:id` для поддержки редактирования тегов.

3. **Frontend: предпросмотр и поля**
   - Реализовать `getIssueInfo` во фронтовом API и предпросмотр во вкладке «Связать с существующей».
   - Добавить предпросмотр шаблона и опциональные поля переопределения во вкладке «Создать задачу в YouTrack».

4. **Frontend: управление тегами**
   - Добавить отображение тегов в списке задач и на детальной странице.
   - Реализовать редактирование тегов на детальной странице задачи.
   - Создать страницу управления чёрным списком тегов (`YouTrackTagsBlacklistPage`).
   - Добавить методы в API клиент для работы с чёрным списком.
   - Добавить навигацию на страницу управления чёрным списком.

5. **Очистка**
   - Удалить `CreateYouTrackIssueDialog.tsx` при отсутствии использования.

6. **Backend: тесты**
   - Написать unit-тесты для youtrack-api, templates, youtrack-links, youtrack-queue и youtrack-processor.
   - Добавить тесты для сервиса чёрного списка тегов.

---

## Выявленные уточнения (по ходу реализации)

Ниже перечислены уточнения и доработки, выявленные при реализации и исправлении багов.

### Backend

1. **Формат entity id в YouTrack**  
   Ответ YouTrack при создании задачи может содержать только внутренний `id` (например `3-994`), без `idReadable` (VTB-538). В манифест и в ответ API нужно писать человекочитаемый id: после создания вызывать GET issue с `fields=idReadable,id` и использовать его (`getIssueIdReadable`).

2. **Нормализация `youtrackIssueIds`**  
   В манифесте в массиве `youtrackIssueIds` могут оказаться `null`. При чтении задач и при работе со связями нужно фильтровать только валидные строки; в ответах API отдавать только массив строк (иначе падает сериализация схемы).

3. **Ответ POST create при успехе**  
   При успешном создании ответ YouTrack может не содержать `idReadable`. Использовать `idReadable ?? id`. Схема ответа (union с queued) требует все поля заполненными; при ошибке «temporarily unavailable» тоже ставить операцию в очередь.

4. **GET /api/youtrack/tasks/:taskId с includeDetails**  
   Без параметра `fields` YouTrack возвращает только id и $type. Для summary/state/priority нужно запрашивать `getIssue(issueId, 'summary,state(name),priority(name)')`. В youtrackData поле `summary` обязательно — подставлять `issue.summary ?? ''`. При недоступности YT не вызывать getIssue — возвращать связи без youtrackData.

5. **Режим работы без YouTrack**  
   При отсутствии YOUTRACK_TOKEN/URL или при недоступности YT не слать запросы в YouTrack: создание/связывание сразу ставить в очередь. При ошибке соединения или 5xx помечать YT как недоступный на 5 минут и не вызывать API до истечения. В роутах при ошибке «temporarily unavailable» тоже возвращать queued. GET связей при недоступном YT не вызывать youtrackApiService.

6. **Очистка контента перед отправкой в YT**  
   В YouTrack не должны попадать номер локальной задачи и строка о ветке. При применении шаблона для YT передавать `taskId: ''` и `branch: ''`. В описании оставлять только контент после первой строки `---` (до неё — заголовок, Статус, Ветки). Из заголовка убирать префикс вида «TASK-053: » (функции `cleanTitleForYoutrack`, `cleanContentForYoutrack` в templates.service).

7. **Родительская задача в шаблоне**  
   В шаблон добавлено опциональное поле `parentIssueId` (idReadable в YT). После создания задачи в YouTrack применять команду `subtask of <parentIssueId>` через POST /api/commands (`applyCommand` в youtrack-api.service).

### Frontend

8. **Ссылка на задачу YouTrack**  
   Ссылку строить на фронте из номера задачи и baseUrl (из env через GET /api/youtrack/config). Хелпер `buildYouTrackIssueUrl(baseUrl, issueId)`. Не опираться на поле `youtrackIssueUrl` в ответах API; в типах сделать его опциональным.

9. **Детальная страница: блок YouTrack**  
   Показывать номер задачи YT только как ссылку (по baseUrl + issueId). Кнопку «Открыть в YouTrack» убрать.

10. **Страница шаблонов**  
    Отображать родительскую задачу шаблона (`parentIssueId`); при наличии baseUrl показывать её как ссылку на задачу в YT.

11. **Форма редактирования шаблона**  
    Поле «ID шаблона» при редактировании — в одну строку вверху (readonly, текст, не input). Поле «Название» — на всю ширину формы.

---

## Связанные документы

- TASK-035: Интеграция Task Viewer Backend с YouTrack
- TASK-036: Интеграция Task Viewer Frontend с YouTrack

---

## Связанные задачи

- **TASK-035**: Интеграция Task Viewer Backend с YouTrack
- **TASK-036**: Интеграция Task Viewer Frontend с YouTrack
