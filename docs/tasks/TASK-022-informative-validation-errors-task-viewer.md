# TASK-022: Информативные ошибки валидации в Task Viewer API и интерфейсе

**Статус**: ✅ Выполнено  
**Ветка**: `feature/temp-private-2110`

---

## Краткое описание

Сделать ошибки валидации и сериализации в Task Viewer (бэкенд и фронтенд) **информативными**: вместо «500 Internal Server Error» и «Failed to fetch tasks» возвращать и отображать в интерфейсе структурированное сообщение с кодом ошибки и списком деталей (путь к полю, текст ошибки, допустимые значения при необходимости).

---

## Главная цель

При несоответствии ответа API схеме (например, недопустимый статус задачи в манифесте) или при ошибках валидации запроса пользователь должен видеть **понятное сообщение и детали** прямо в интерфейсе Task Viewer, а не только 500 в консоли или общую фразу «Ошибка загрузки задач».

---

## Цели

1. **Бэкенд:** единый формат тела ошибки API: `message`, `code`, при необходимости массив `details` с полями `path`, `message`, `expectedValues`.
2. **Бэкенд:** глобальный обработчик ошибок Fastify, который перехватывает ошибки сериализации ответа (Zod) и ошибки валидации запроса и возвращает HTTP 422/400 с этим телом.
3. **Фронтенд:** разбор ответа с ошибкой (JSON) и создание объекта ошибки с полями `message`, `code`, `details`.
4. **Фронтенд:** отображение ошибки на страницах списка и детали задачи: заголовок, текст сообщения, список «Детали валидации» (путь, сообщение, допустимые значения), кнопка «Повторить запрос».
5. **Фронтенд:** при ошибках обновления статуса в списке и сохранения в диалоге редактирования — показ текста ошибки через toast (то же сообщение, что пришло с API).

---

## Обязательные требования

### Бэкенд (taskViewerBe)

- **Глобальный `setErrorHandler`** в приложении Fastify:
  - При ошибке **сериализации ответа** (ответ не прошёл Zod, напр. неверный `status` в манифесте): HTTP **422**, тело `{ message, code: "VALIDATION_ERROR", details }`. В `details` — элементы с `path` (строка, напр. `"16.status"`), `message`, при наличии — `expectedValues` (массив допустимых значений).
  - При ошибках **валидации тела/параметров запроса**: HTTP **400**, тот же формат тела с `details`.
  - Для остальных ошибок — единый формат: `{ message, code }`, без `details`.
- Использование `isResponseSerializationError` из `fastify-type-provider-zod` и извлечение из `err.cause.issues` полей для формирования `details`.

### Фронтенд (taskViewerFe)

- **Класс/тип ошибки API** (напр. `ApiError`): поля `message`, `code`, `details` (массив `{ path, message, expectedValues? }`), опционально `statusCode`. Статический метод создания из `Response` (парсинг JSON тела).
- **API-клиент** (`tasks.api.ts`): при `!response.ok` не бросать общий `Error('Failed to fetch tasks')`, а парсить тело ответа и бросать `ApiError` с полями из ответа.
- **Страница списка задач:** при ошибке загрузки показывать карточку с заголовком «Ошибка загрузки задач», текстом `error.message`, при наличии `error.details` — список «Детали валидации» (путь, сообщение, допустимые значения), кнопка «Повторить запрос».
- **Страница детали задачи:** аналогично — карточка ошибки с сообщением, деталями и кнопкой «Повторить запрос».
- **Хук `useTasks`:** хранить в состоянии полный объект ошибки (`Error | null`), чтобы в UI можно было проверить `instanceof ApiError` и использовать `details`.
- **Обновление статуса в списке и сохранение в диалоге редактирования:** при ошибке показывать `toast.error` с текстом из ответа API (`error.message`).

---

## Реализованные артефакты

### Бэкенд

- `taskViewerBe/src/app.ts` — добавлены типы `ValidationDetail`, `ApiErrorBody`, функция `formatValidationDetails`, регистрация `setErrorHandler` с обработкой ошибок сериализации и валидации запроса.

### Фронтенд

- `taskViewerFe/src/api/apiError.ts` — класс `ApiError` с полями `message`, `code`, `details`, `statusCode` и статический метод `ApiError.fromResponse(response)`.
- `taskViewerFe/src/api/tasks.api.ts` — при `!response.ok` вызов `ApiError.fromResponse(response)` и выброс `ApiError`.
- `taskViewerFe/src/hooks/useTasks.ts` — тип состояния ошибки изменён на `Error | null`.
- `taskViewerFe/src/pages/TasksListPage.tsx` — блок ошибки заменён на карточку с сообщением, списком деталей и кнопкой «Повторить запрос».
- `taskViewerFe/src/pages/TaskDetailPage.tsx` — аналогичный блок ошибки с деталями и кнопкой повтора.
- `taskViewerFe/src/components/TaskList.tsx` — при ошибке смены статуса вызов `toast.error(message)` с текстом из ошибки.
- `taskViewerFe/src/components/TaskEditDialog.tsx` — при ошибке сохранения вызов `toast.error(message)` с текстом из ошибки.

---

## Критерии приёмки

- [x] При ошибке сериализации ответа (напр. недопустимый `status` в манифесте) API возвращает 422 с телом `{ message, code: "VALIDATION_ERROR", details }`.
- [x] В `details` присутствуют `path`, `message`, при необходимости `expectedValues`.
- [x] Фронтенд при неуспешном ответе API создаёт и бросает `ApiError` с полями из ответа.
- [x] На странице списка и странице детали задачи при ошибке отображаются сообщение, список деталей валидации (если есть) и кнопка «Повторить запрос».
- [x] При ошибке обновления статуса в списке и сохранения в диалоге редактирования показывается toast с текстом ошибки от API.

---

## Вне границ задачи

- Изменение набора допустимых статусов в схеме (добавление статуса `planned` и отображение его в UI) было выполнено ранее в рамках исправления исходной ошибки; в данной задаче фиксируется только улучшение формата ошибок и их отображения.
- Централизованная система логирования ошибок на бэкенде не входит в задачу.

---

## Связанные артефакты

- Бэкенд Task Viewer: `taskViewerBe/`
- Фронтенд Task Viewer: `taskViewerFe/`
- Манифест задач: `docs/tasks/tasks-manifest.json`
