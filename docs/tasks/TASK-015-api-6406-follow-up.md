# TASK-015: Доработки API формы 6406 (следующие шаги)

**Статус**: ✅ Выполнено  
**Ветка**: `feature/TASK-015-api-6406-follow-up`

**Связь**: Вынесено из TASK-014 (задания на будущее).

---

## Выполнено в рамках задачи

- **П.5 (createdBy)** — Решение зафиксировано в api-conventions: поле `createdBy` всегда строка (пустая строка при автоматическом создании), не nullable.
- **П.7 (типизация items в OpenAPI)** — Улучшено сравнение схем в генерации OpenAPI (app.ts): при сравнении объектов учитывается тип элементов массивов, чтобы ответ POST /tasks/list (TasksListResponseDto с `items` типа TaskListItemDto[]) не сливался с PaginatedResponseDto; в api-conventions добавлено требование явной типизации `items` в ответах со списками.
- **П.10 (конечные слеши)** — Маршруты уже без конечного слеша; исправлен комментарий в tasks.schema.ts (GET /tasks/ → POST /tasks/list); в api-conventions добавлен раздел «Единообразие URL» — без конечных слешей.
- **П.12 (документация)** — Обновлён docs/api-conventions.md: разделы «Единообразие URL», «Поле createdBy», «Типизация ответов со списками».

Пункты 1–4, 6, 8–9 были выполнены в TASK-014. П.11 (разделение хранилища) остаётся открытым продуктовым/архитектурным вопросом.

---

## Краткое описание

Список конкретных действий по контракту API, типизации ответов, фильтрации/сортировке, URL и открытым вопросам — для реализации после TASK-014 или в рамках отдельного спринта.

---

## По контракту API (замечания 1–5, 7)

1. **Сделать currency опциональным при создании задания**  
   В схеме создания (POST /tasks/) поле `currency` сделать необязательным (`currencySchema.optional()`), в ответе оставить по TASK-012.  
   *Примечание: в TASK-014 уже выполнено.*

2. **Уточнить описание поля source**  
   В CreateTaskDto и в ответах: описание «Ссылка на справочник или идентификатор источника данных».  
   *Примечание: в TASK-014 уже выполнено.*

3. **Уточнить формулировки для отмены заданий**  
   В описании POST /tasks/cancel и в описании статуса указать: на нашей стороне — «Задание отменено»; синхронизация с внешней системой может приводить к статусу KILLED_DAPP.  
   *Примечание: в TASK-014 уже выполнено.*

4. **Усилить описание семантики fileSize и totalSize**  
   В схемах явно указать: для заданий `fileSize` — «null = размер ещё не рассчитан»; для пакетов `totalSize` — «всегда число, 0 при пустом пакете».  
   *Примечание: в TASK-014 уже выполнено.*

5. **Принять решение по createdBy (null vs строка)**  
   Зафиксировать: либо оставить «всегда не null» (пустая строка при автоматическом создании), либо ввести nullable и обновить описание/контракт; при расхождении с продуктом — согласовать с TASK-011.  
   *См. также: [api-6406-requirements-conflicts.md](./api-6406-requirements-conflicts.md).*

6. **Переименовать accountMaskSecondOrder → accountSecondOrder**  
   В схемах создания задания (POST /tasks/), в ответах (детали задания) и в БД/сервисах: поле «счета второго порядка» именовать `accountSecondOrder`.  
   *Примечание: в TASK-014 уже выполнено.*

---

## Типизация ответов со списками (замечание 6)

7. **Проверить и при необходимости исправить типизацию items в OpenAPI**  
   Убедиться, что ответ POST /tasks/list и все остальные ответы с массивами в сгенерированной спецификации имеют явный тип элементов (например, `items.$ref` на TaskListItemDto), а не обобщённый «array без items». Пройти по таблице из TASK-014 («Проверка остальных респонсов») и при необходимости поправить генерацию/схемы.

---

## Фильтрация и сортировка

8. **Сделать параметры фильтрации списка заданий детерминированными**  
   Строго задать: допустимые колонки фильтра (enum по полям списка заданий), допустимые операторы, формат значения в зависимости от колонки (статус — enum, даты — YYYY-MM-DD, дата-время — ISO 8601). Описать в OpenAPI и при необходимости валидировать на BE.  
   *Примечание: в TASK-014 уже введены enum колонок сортировки и фильтрации.*

9. **Сделать колонку сортировки списка заданий строго типизированной**  
   Вместо произвольной строки использовать enum допустимых колонок для сортировки (в соответствии с полями, по которым реально строится ORDER BY).  
   *Примечание: в TASK-014 уже выполнено (taskListSortColumnSchema, tasksListSortingSchema).*

---

## Единообразие маршрутов (URL)

10. **Убрать конечные слеши у эндпоинтов**  
   Найти все маршруты API формы 6406, у которых в путях есть завершающий слеш, и привести к единому виду — без конечного слеша (в регистрации роутов, в OpenAPI-спецификации и в документации).

---

## Открытые вопросы и решения

11. **Решение по разделению хранилища (корзина отчётов vs корзина ТФР)**  
   Продуктовое/архитектурное решение: будет ли разделение; если да — зафиксировать в документации API и в контракте мониторинга хранилища (Report 6406 — Storage).

12. **Зафиксировать итоговые решения в документации**  
   После выполнения пунктов 1–11 обновить api-conventions (или аналог) и описание API формы 6406: обязательность полей, форматы размеров, статусы, пагинация/сортировка/фильтрация, типизация ответов, единообразие URL.
