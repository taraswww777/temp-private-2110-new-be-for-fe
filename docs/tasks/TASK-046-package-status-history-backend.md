# TASK-046: История статусов пакета - Backend

**Статус**: ✅ Выполнено
**Ветка**: `feature/TASK-046-package-status-history-backend`

---

## Краткое описание

Реализовать функционал истории статусов пакета на Backend: добавить колонку "Статус пакета" в список пакетов, создать endpoint для получения истории статусов пакета.

---

## Исходное описание задачи

> Данный раздел содержит оригинальное описание задачи для оперативного обращения.

**Источник:** [Замечания от 06.02.2026](https://github.com/taraswww777/temp-private-2110-new-be-for-fe/blob/feature/Masha/docs/Правки%20от%2006.02.md#6406)

### Список пакетов. История статусов Пакета

1. Добавить колонку "Статус пакета" - показывать текущий статус пакета

2. Добавить функционал "История статусов пакета" (по аналогии с `История статусов задачи`, функционал под вопросом?!!!!!!!!!!!!!!!!!!!!)

Отображаем:
• Наименование пакета
• Статус
• Сотрудник - пользователь, который создал/ изменил пакет

3. Статусы пакета: <https://sfera.inno.local/knowledge/pages?id=1799080>

### Детализация пакета. История статусов Пакета

Отображаем в отдельной табе как в детальной странице Задачи на построение отчёта

---

## Цели

- Добавить колонку "Статус пакета" в список пакетов
- Реализовать endpoint для получения истории статусов пакета
- Обеспечить отображение истории статусов в детализации пакета

---

## Детальное описание

### Контекст

Необходимо реализовать функционал истории статусов пакета по аналогии с историей статусов задачи. Статусы пакета описаны в документации.

### Требования

#### 1. Колонка "Статус пакета" в списке пакетов

**Endpoint:** `GET /api/v1/report-6406/packages` (или POST для списка)

**Изменения:**
- Добавить поле `status` в `PacketDto` (если отсутствует)
- Возвращать текущий статус пакета в списке

#### 2. Endpoint истории статусов пакета

**Endpoint:** `GET /api/v1/report-6406/packages/:id/status-history`

**Response:**
```json
{
  "items": [
    {
      "status": "created",
      "changedAt": "2026-02-05T10:00:00Z",
      "changedBy": "user.login",
      "packetName": "Название пакета"
    },
    {
      "status": "copying",
      "changedAt": "2026-02-05T11:00:00Z",
      "changedBy": "user.login",
      "packetName": "Название пакета"
    }
  ],
  "totalItems": 2
}
```

**Поля:**
- `status` - статус пакета (enum из статусной модели)
- `changedAt` - дата и время изменения статуса
- `changedBy` - логин пользователя, изменившего статус
- `packetName` - наименование пакета (для каждого изменения)

**Примечание:** Функционал под вопросом, требуется уточнение.

#### 3. Статусы пакета

**Источник:** <https://sfera.inno.local/knowledge/pages?id=1799080>

Необходимо изучить документацию и реализовать статусную модель пакета.

---

## Критерии приёмки

### Колонка "Статус пакета"
- [ ] Поле `status` добавлено в `PacketDto`
- [ ] Список пакетов возвращает статус для каждого пакета
- [ ] Обновлена OpenAPI спецификация

### История статусов пакета
- [ ] Реализован endpoint `GET /api/v1/report-6406/packages/:id/status-history`
- [ ] Endpoint возвращает историю статусов пакета
- [ ] Данные берутся из таблицы истории статусов (если существует)
- [ ] Реализована сортировка по дате изменения
- [ ] Обновлена OpenAPI спецификация
- [ ] Добавлены unit-тесты

### Статусная модель
- [ ] Изучена документация по статусам пакета
- [ ] Реализована статусная модель согласно документации
- [ ] Enum статусов экспортирован в Swagger

### Общие критерии
- [ ] Все изменения протестированы
- [ ] Документация обновлена

---

## Порядок выполнения

1. Изучить документацию по статусам пакета
2. Проанализировать структуру таблицы истории статусов (если существует)
3. Добавить поле `status` в `PacketDto`
4. Реализовать endpoint истории статусов
5. Обновить OpenAPI спецификацию
6. Написать unit-тесты
7. Протестировать функционал

---

## Связанные документы

- [Замечания от 06.02.2026](https://github.com/taraswww777/temp-private-2110-new-be-for-fe/blob/feature/Masha/docs/Правки%20от%2006.02.md)
- [Статусы пакета](https://sfera.inno.local/knowledge/pages?id=1799080)
- TASK-027: Добавление эндпоинта истории изменения статусов задачи

---

## Уточнения

**Важно:** Функционал истории статусов пакета под вопросом. Требуется уточнение необходимости реализации перед началом работы.

**Выявленные уточнения:**
1. Статусы пакета должны быть определены через enum с следующими значениями:
   - pack_create - Создано
   - pack_transfer - Копирование
   - pack_done - Выполнено
   - pack_fail - Не выполнено
   - pack_cancel - Отменено
   - pack_delete - Удалено

2. Endpoint `/api/v1/report-6406/packages/{id}/status-history` должен возвращать просто массив статусов без обертки в объект с полями items и totalItems

3. Статусы должны быть реализованы через PostgreSQL enum (packetStatusPgEnum) с использованием значений из TypeScript enum PacketStatusEnum

4. Таблица истории статусов должна содержать поля: packetId, status, previousStatus, changedAt, changedBy, createdAt

5. Поле status должно быть добавлено в DTO пакета и таблицу базы данных с значением по умолчанию 'pack_create'

6. Ответ при ошибке 404 должен соответствовать RFC 7231 с полями type, title, status, detail и instance
