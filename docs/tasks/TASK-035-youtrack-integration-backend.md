# TASK-035: Интеграция Task Viewer Backend с YouTrack

**Статус**: ✅ Выполнено  
**Ветка**: `feature/TASK-035-youtrack-integration-backend`

---

## Краткое описание

Реализовать интеграцию Task Viewer Backend с YouTrack для автоматического создания задач в YouTrack, связывания локальных задач с задачами в YouTrack и управления шаблонами заданий.

---

## Цели

- Реализовать создание новых задач в YouTrack через REST API
- Добавить возможность связывания локальных задач (из tasks-manifest.json) с задачами в YouTrack
- Реализовать систему шаблонов для создания задач в YouTrack
- Добавить API endpoints для работы с YouTrack интеграцией
- Обеспечить хранение связи между локальными задачами и задачами YouTrack
- Обеспечить работу приложения без доступа к YouTrack: операции записываются в очередь и выполняются при следующем запуске BE; очередь операций хранится в репозитории (под git-индексацией)

---

## Детальное описание

### Контекст

YouTrack доступен по адресу: `http://dvuaod-00app001.innodev.local:8080`
Для доступа требуется VPN подключение, поэтому отладка будет проводиться на другом компьютере.

### Требования

#### 1. Конфигурация

**Переменные окружения (.env):**
```env
# YouTrack настройки
YOUTRACK_URL=http://dvuaod-00app001.innodev.local:8080
YOUTRACK_TOKEN=<permanent-token>
YOUTRACK_PROJECT_ID=<project-id>  # Опционально, можно получать динамически
```

#### 2. Создание задач в YouTrack

**API Endpoint:** `POST /api/youtrack/tasks`

**Функциональность:**
- Создание новой задачи в YouTrack на основе локальной задачи
- Использование шаблона для заполнения полей
- Автоматическое связывание созданной задачи YouTrack с локальной задачей
- Возврат ID созданной задачи в YouTrack

**Request Body:**
```json
{
  "taskId": "TASK-035",
  "templateId": "default",  // Опционально
  "customFields": {          // Опционально, переопределение шаблона
    "Priority": "Show-stopper",
    "Assignee": "user.login"
  }
}
```

**Response:**
```json
{
  "localTaskId": "TASK-035",
  "youtrackIssueId": "PROJ-123",
  "youtrackIssueUrl": "http://dvuaod-00app001.innodev.local:8080/issue/PROJ-123",
  "youtrackIssueIds": ["PROJ-123"]  // Обновлённый массив всех связей
}
```

#### 3. Связывание существующих задач

**API Endpoint:** `POST /api/youtrack/tasks/:taskId/link`

**Функциональность:**
- Ручное связывание локальной задачи с существующей задачей в YouTrack
- Добавление ID задачи в массив `youtrackIssueIds` в манифесте
- Предотвращение дублирования (проверка наличия ID перед добавлением)

**Request Body:**
```json
{
  "youtrackIssueId": "PROJ-123"
}
```

**Response:**
```json
{
  "localTaskId": "TASK-035",
  "youtrackIssueId": "PROJ-123",
  "youtrackIssueUrl": "http://dvuaod-00app001.innodev.local:8080/issue/PROJ-123",
  "youtrackIssueIds": ["PROJ-123"]  // Обновлённый массив всех связей
}
```

**Если ID уже существует:**
- Возвращается ошибка 400 с сообщением о том, что связь уже существует

#### 4. Получение информации о связях

**API Endpoint:** `GET /api/youtrack/tasks/:taskId`

**Функциональность:**
- Получение информации о всех связях локальной задачи с YouTrack
- Получение метаданных задач из YouTrack (если доступно)

**Response:**
```json
{
  "localTaskId": "TASK-035",
  "youtrackIssueIds": ["PROJ-123", "PROJ-124"],
  "links": [
    {
      "youtrackIssueId": "PROJ-123",
      "youtrackIssueUrl": "http://dvuaod-00app001.innodev.local:8080/issue/PROJ-123",
      "youtrackData": {
        "summary": "Название задачи",
        "state": "Open",
        "priority": "Show-stopper"
      }
    },
    {
      "youtrackIssueId": "PROJ-124",
      "youtrackIssueUrl": "http://dvuaod-00app001.innodev.local:8080/issue/PROJ-124",
      "youtrackData": {
        "summary": "Другая связанная задача",
        "state": "In Progress",
        "priority": "Normal"
      }
    }
  ]
}
```

**Если связей нет:**
```json
{
  "localTaskId": "TASK-035",
  "youtrackIssueIds": [],
  "links": []
}
```

#### 5. Удаление связи

**API Endpoint:** `DELETE /api/youtrack/tasks/:taskId/link/:youtrackIssueId`

**Функциональность:**
- Удаление конкретной связи локальной задачи с задачей в YouTrack
- Удаление ID задачи из массива `youtrackIssueIds` в манифесте

**Response:**
```json
{
  "localTaskId": "TASK-035",
  "removedIssueId": "PROJ-123",
  "youtrackIssueIds": []  // Обновлённый массив всех связей (после удаления)
}
```

**Если связи не существует:**
- Возвращается ошибка 404 с сообщением о том, что связь не найдена

#### 6. Управление шаблонами

**API Endpoint:** `GET /api/youtrack/templates`
**API Endpoint:** `GET /api/youtrack/templates/:templateId`
**API Endpoint:** `POST /api/youtrack/templates`
**API Endpoint:** `PUT /api/youtrack/templates/:templateId`
**API Endpoint:** `DELETE /api/youtrack/templates/:templateId`

**Функциональность:**
- Создание, чтение, обновление и удаление шаблонов для задач YouTrack
- Шаблоны хранятся в файловой системе (JSON файлы в `docs/tasks/youtrack-templates/`)

**Структура шаблона:**
```json
{
  "id": "default",
  "name": "Шаблон по умолчанию",
  "description": "Базовый шаблон для создания задач",
  "projectId": "0-0",
  "summaryTemplate": "{{title}}",
  "descriptionTemplate": "{{content}}\n\n**Локальная задача:** {{taskId}}",
  "customFields": {
    "Priority": {
      "$type": "SingleEnumIssueCustomField",
      "value": {
        "name": "Normal"
      }
    },
    "Type": {
      "$type": "SingleEnumIssueCustomField",
      "value": {
        "name": "Task"
      }
    }
  }
}
```

**Поддержка переменных в шаблонах:**
- `{{taskId}}` - ID локальной задачи
- `{{title}}` - Название локальной задачи
- `{{content}}` - Содержимое markdown файла задачи
- `{{status}}` - Статус локальной задачи
- `{{branch}}` - Git ветка задачи

#### 7. Хранение связей

**Файл:** `docs/tasks/tasks-manifest.json`

**Структура:** Связи хранятся прямо в манифесте задач как опциональное поле `youtrackIssueIds` (массив строк) для каждой задачи.

**Пример структуры задачи в манифесте:**
```json
{
  "id": "TASK-035",
  "title": "Интеграция Task Viewer Backend с YouTrack",
  "status": "backlog",
  "file": "TASK-035-youtrack-integration-backend.md",
  "createdDate": "2026-02-06T10:00:00Z",
  "completedDate": null,
  "branch": null,
  "youtrackIssueIds": ["PROJ-123", "PROJ-124"]  // Опциональное поле, массив ID задач в YouTrack
}
```

**Особенности:**
- Поле `youtrackIssueIds` опциональное (может отсутствовать)
- Если задача не связана с YouTrack, поле отсутствует или равно `null`
- Одна локальная задача может быть связана с несколькими задачами в YouTrack (массив)
- ID задач хранятся в формате readable ID (например, "PROJ-123")

#### 8. Работа без доступа к YouTrack (очередь операций)

**Требование:** Приложение должно корректно работать и без доступа к YouTrack (например, без VPN). В таком случае запрашиваемые операции не выполняются сразу, а **записываются в очередь** и выполняются автоматически при **следующем запуске Backend**, когда доступ к YouTrack появится.

**Функциональность:**
- При отсутствии конфигурации YouTrack (YOUTRACK_URL, YOUTRACK_TOKEN) или при недоступности YouTrack API запросы на создание задачи, связывание и удаление связи не возвращают ошибку, а добавляют операцию в очередь.
- Очередь хранится в файловой системе: `docs/tasks/youtrack-queue/queue.json`.
- **Все данные очереди операций (транзакций) должны находиться под git-индексацией** — папка `docs/tasks/youtrack-queue/` и файл очереди (при его наличии) включаются в репозиторий.
- При старте приложения выполняется автоматическая обработка очереди: все операции со статусом `pending` выполняются, если YouTrack доступен.
- Поддерживаются типы операций: создание задачи в YouTrack (`create_issue`), связывание (`link_issue`), удаление связи (`unlink_issue`).
- Для операций в очереди предусмотрены повторные попытки при ошибках; после превышения лимита попыток операция помечается как `failed`.

**Ответ API при постановке в очередь (вместо немедленного выполнения):**
- В теле ответа возвращаются поля `queued: true` и `operationId` (ID операции в очереди). Поля `youtrackIssueId` / `youtrackIssueUrl` могут быть пустыми до фактического выполнения.

**Управление очередью:**
- `GET /api/youtrack/queue` — получить статус очереди (количество по статусам, список операций).
- `POST /api/youtrack/queue/process` — вручную запустить обработку всех pending операций (если YouTrack доступен).

### Технические детали

#### YouTrack REST API

**Базовый URL:** `http://dvuaod-00app001.innodev.local:8080/api`

**Аутентификация:**
- Использовать Permanent Token в заголовке `Authorization: Bearer <token>`
- Токен хранится в переменной окружения `YOUTRACK_TOKEN`

**Основные endpoints:**
1. `GET /admin/projects` - получение списка проектов
2. `POST /issues` - создание новой задачи
3. `GET /issues/{issueId}` - получение информации о задаче
4. `GET /issues/{issueId}/customFields` - получение кастомных полей задачи

**Пример создания задачи:**
```typescript
const response = await fetch(`${YOUTRACK_URL}/api/issues`, {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${YOUTRACK_TOKEN}`,
    'Content-Type': 'application/json',
    'Accept': 'application/json'
  },
  body: JSON.stringify({
    project: { id: projectId },
    summary: "Название задачи",
    description: "Описание задачи",
    customFields: [
      {
        name: "Priority",
        "$type": "SingleEnumIssueCustomField",
        value: { name: "Show-stopper" }
      }
    ]
  })
});
```

#### Обработка ошибок

- Валидация наличия токена и URL перед запросами
- Обработка сетевых ошибок (таймауты, недоступность сервера)
- Обработка ошибок YouTrack API (400, 401, 403, 404)
- Логирование ошибок для отладки

#### Валидация

- Использование Zod схем для валидации запросов
- Проверка существования локальной задачи перед созданием связи
- Валидация шаблонов при создании/обновлении

---

## Критерии приёмки

### Конфигурация
- [ ] Добавлены переменные окружения для YouTrack в `.env.example`
- [ ] Реализована загрузка конфигурации YouTrack из переменных окружения (опциональные переменные; приложение стартует и без них)
- [ ] Валидация наличия обязательных переменных выполняется только при обращении к YouTrack API

### Создание задач в YouTrack
- [ ] Реализован endpoint `POST /api/youtrack/tasks` для создания задач
- [ ] Поддержка использования шаблонов при создании
- [ ] Автоматическое связывание созданной задачи с локальной
- [ ] Возврат корректной информации о созданной задаче
- [ ] Обработка ошибок создания задачи

### Связывание задач
- [ ] Реализован endpoint `POST /api/youtrack/tasks/:taskId/link` для ручного связывания
- [ ] Валидация существования локальной задачи
- [ ] Валидация существования задачи в YouTrack
- [ ] Сохранение связи в манифесте (добавление ID в массив `youtrackIssueIds`)
- [ ] Предотвращение дублирования связей (проверка наличия ID перед добавлением)
- [ ] Возврат ошибки 400 если связь уже существует

### Удаление связи
- [ ] Реализован endpoint `DELETE /api/youtrack/tasks/:taskId/link/:youtrackIssueId` для удаления связи
- [ ] Валидация существования локальной задачи
- [ ] Валидация существования связи
- [ ] Удаление ID из массива `youtrackIssueIds` в манифесте
- [ ] Возврат ошибки 404 если связь не найдена

### Получение информации о связях
- [ ] Реализован endpoint `GET /api/youtrack/tasks/:taskId`
- [ ] Возврат массива всех связанных задач YouTrack (`youtrackIssueIds`)
- [ ] Возврат детальной информации о каждой связи (если запрошено)
- [ ] Опциональное получение метаданных из YouTrack для каждой связи
- [ ] Обработка случая отсутствия связей (пустой массив)

### Управление шаблонами
- [ ] Реализованы CRUD endpoints для шаблонов
- [ ] Хранение шаблонов в файловой системе
- [ ] Поддержка переменных в шаблонах ({{taskId}}, {{title}}, и т.д.)
- [ ] Валидация структуры шаблонов
- [ ] Обработка ошибок при работе с шаблонами

### Хранение данных
- [ ] Добавлено опциональное поле `youtrackIssueIds` (массив строк) в схему задачи в манифесте
- [ ] Обновлена схема Zod для поддержки `youtrackIssueIds`
- [ ] Создана папка `docs/tasks/youtrack-templates/` для шаблонов
- [ ] Реализованы сервисы для работы с манифестом (добавление/удаление связей)
- [ ] Реализованы сервисы для работы с шаблонами
- [ ] Атомарные операции записи манифеста (предотвращение потери данных)
- [ ] Создана папка `docs/tasks/youtrack-queue/` для очереди операций; очередь и связанные данные под git-индексацией

### YouTrack API клиент
- [ ] Реализован сервис для работы с YouTrack REST API
- [ ] Получение списка проектов
- [ ] Создание задач с кастомными полями
- [ ] Получение информации о задаче
- [ ] Обработка ошибок API

### Валидация и схемы
- [ ] Созданы Zod схемы для всех запросов и ответов
- [ ] Валидация шаблонов через Zod
- [ ] Валидация связей через Zod

### Документация
- [ ] Обновлен README.md с описанием интеграции
- [ ] Добавлены примеры использования API
- [ ] Описаны переменные окружения
- [ ] Добавлена документация по шаблонам

### Работа без доступа к YouTrack (очередь операций)
- [ ] При отсутствии доступа к YouTrack операции (создание задачи, связывание, удаление связи) записываются в очередь, а не возвращают ошибку
- [ ] Очередь хранится в файле `docs/tasks/youtrack-queue/queue.json`; папка очереди и её содержимое под git-индексацией
- [ ] При старте Backend выполняется автоматическая обработка pending операций, если YouTrack доступен
- [ ] Реализованы endpoints `GET /api/youtrack/queue` и `POST /api/youtrack/queue/process`
- [ ] Ответы API при постановке в очередь содержат `queued: true` и `operationId`
- [ ] Реализованы повторные попытки выполнения операций из очереди; операции могут помечаться как `failed` после исчерпания попыток

### Тестирование
- [ ] Unit-тесты для YouTrack API клиента (моки)
- [ ] Unit-тесты для сервисов работы с шаблонами
- [ ] Unit-тесты для сервисов работы со связями
- [ ] Unit-тесты для сервиса очереди операций
- [ ] Интеграционные тесты (если возможно без VPN)

---

## Порядок выполнения

### Этап 1: Подготовка инфраструктуры
1. Добавить переменные окружения в `.env.example`
2. Создать конфигурационный модуль для YouTrack
3. Создать структуру папок для шаблонов и связей
4. Создать базовые типы и схемы Zod

### Этап 2: YouTrack API клиент
1. Реализовать функцию получения списка проектов
2. Реализовать функцию создания задачи
3. Реализовать функцию получения информации о задаче
4. Добавить обработку ошибок и логирование

### Этап 3: Система шаблонов
1. Реализовать CRUD операции для шаблонов
2. Реализовать парсинг переменных в шаблонах
3. Реализовать применение шаблона при создании задачи
4. Добавить валидацию шаблонов

### Этап 4: Хранение связей
1. Добавить поле `youtrackIssueIds` в схему задачи (Zod)
2. Обновить типы TypeScript для поддержки `youtrackIssueIds`
3. Реализовать функции добавления связи (добавление ID в массив)
4. Реализовать функции удаления связи (удаление ID из массива)
5. Реализовать функции получения связей (чтение из манифеста)
6. Обновить сервис работы с манифестом для поддержки связей
7. Добавить валидацию данных

### Этап 5: API Endpoints
1. Реализовать `POST /api/youtrack/tasks` - создание задачи
2. Реализовать `POST /api/youtrack/tasks/:taskId/link` - связывание
3. Реализовать `GET /api/youtrack/tasks/:taskId` - получение связи
4. Реализовать CRUD endpoints для шаблонов
5. Добавить валидацию запросов через Zod

### Этап 6: Очередь операций (работа без доступа к YouTrack)
1. Реализовать хранение очереди в `docs/tasks/youtrack-queue/queue.json`; обеспечить git-индексацию папки и файла очереди
2. При отсутствии доступа к YouTrack добавлять операции в очередь вместо немедленного выполнения
3. При старте приложения обрабатывать pending операции из очереди
4. Добавить `GET /api/youtrack/queue` и `POST /api/youtrack/queue/process`
5. Реализовать повторные попытки и статусы операций (pending, completed, failed)

### Этап 7: Тестирование и документация
1. Написать unit-тесты (включая сервис очереди)
2. Обновить документацию
3. Создать примеры использования
4. Провести ручное тестирование (на компьютере с VPN)

---

## Уточнения в процессе выполнения

1. **Работа без доступа к YouTrack.** Приложение должно уметь работать без доступа к YouTrack (например, без VPN). В этом случае нужные операции (создание задачи в YouTrack, связывание, удаление связи) не выполняются сразу, а **запланировываются** и выполняются при **следующем запуске Backend**, когда доступ к YouTrack появится.

2. **Git-индексация очереди.** Все задания по транзакциям (очередь операций YouTrack) должны быть под git-индексацией: очередь хранится в файловой системе в репозитории (папка `docs/tasks/youtrack-queue/`, файл `queue.json` при наличии).

---

## Связанные документы

- [YouTrack REST API Documentation](https://www.jetbrains.com/help/youtrack/devportal/api-howto-create-issue.html)
- [YouTrack Custom Fields](https://www.jetbrains.com/help/youtrack/devportal/api-howto-create-issue-with-fields.html)
- TASK-036: Интеграция Task Viewer Frontend с YouTrack

---

## Связанные задачи

- **TASK-036**: Интеграция Task Viewer Frontend с YouTrack - frontend часть интеграции

---


