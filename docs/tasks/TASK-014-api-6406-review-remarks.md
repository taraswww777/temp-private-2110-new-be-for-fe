# TASK-014: Разбор замечаний и вопросов по API формы 6406

**Статус**: ✅ Выполнено  
**Ветка**: `feature/TASK-014-api-6406-review-remarks`

---

## Краткое описание

Зафиксировать и по возможности устранить замечания по API report-6406: несоответствия в обязательности полей, форматы размеров, формулировки статусов, вопросы по полю `createdBy` и организации хранилища отчётов; типизация `items` в пагинированных ответах; переименование `accountMaskSecondOrder` в `accountSecondOrder`; единообразие URL (без конечных слешей); детерминированность параметров фильтрации и сортировки списка заданий.

---

## Оригинальное описание задачи

> Ниже приведён исходный текст замечаний без изменений.

```
1. /api/v1/report-6406/tasks/ Создать новое задание на построение отчета
Request body
Есть обязательные поля для создания
currency* - не обязательное поле для создания
"source": "string" - рссылка на справочник


Responses
 "canCancel": true,
  "canDelete": true,
  "canStart": true,
За возможность удаления, создания итд будет отвечать поле статус

  

2. Разные форматы размеров: 

/api/v1/report-6406/packages/Создать новый пакет
totalSize*	integer
minimum: 0
maximum: 9007199254740991


/api/v1/report-6406/tasks/ Создать новое задание на построение оттчета
fileSize*	{
anyOf ->	
number
null

/api/v1/report-6406/tasks/{id} Детали
fileSize*	{
anyOf ->	
number
null
}



3. /api/v1/report-6406/tasks/{id} Получить детальную информацию о задании
createdBy*	{
anyOf ->	
string
null - почему? Задание может к нам прийти автоматиески без участия пользователя?


Report 6406 - Storage
Мониторинг хранилища отчётов 

Будет ли разделение: корзина для отчетов , розина для ТФР?



4. /api/v1/report-6406/tasks/  Получить список заданий с пагинацией и фильтрацией
В запросе будут указаны параметры sortBy? параметры пагинации? 



5. /api/v1/report-6406/tasks/cancel Отменить несколько заданий
"Отменяет задания (переводит в статус KILLED_DAPP). Возвращает 200 OK с детальной информацией о результате операции для каждого задания. " - Неправильная формулировка

Переводит задания в статус "Задание отменено" (на нашей стороне). А потом уже предполагаю будет KILLED_DAPP 
```

---

## Сводка замечаний

| № | Область | Суть замечания |
|---|--------|----------------|
| 1 | POST /tasks/ (создание) | `currency` помечено как обязательное, но не должно быть; уточнить `source` (ссылка на справочник); canCancel/canDelete/canStart определяются статусом |
| 2 | Размеры | Несогласованность: пакеты — `totalSize` (integer), задания — `fileSize` (number \| null); унифицировать или задокументировать |
| 3 | GET /tasks/{id} | `createdBy` допускает null — почему? (задание может создаваться автоматически); вопрос по разделению хранилища: корзина отчётов vs корзина ТФР |
| 4 | GET /tasks/ | Уточнить наличие и вид параметров `sortBy` и пагинации в запросе |
| 5 | POST /tasks/cancel | Формулировка про KILLED_DAPP неточна: на нашей стороне статус «Задание отменено», KILLED_DAPP — последующий этап |
| 6 | POST /tasks/list и др. | В ответах с пагинацией (`PaginatedResponseDto` и аналогах) поле `items` обязательно должно быть типизировано (массив конкретного DTO), а не «массив чего угодно». Проверить и при необходимости исправить все такие респонсы. |
| 7 | POST /tasks/, GET /tasks/{id}, схемы | Поле `accountMaskSecondOrder` переименовать в `accountSecondOrder` — счета второго порядка (семантика не «маска», а именно счета второго порядка). |
| 8 | Маршруты (URL) | У части эндпоинтов в спецификации или в коде есть конечные слеши; привести все пути к единому виду (без завершающего слеша). |

---

## Требование: типизация items в пагинированных и списковых ответах

### Задача

Исправить response метода **POST /api/v1/report-6406/tasks/list** (и при необходимости остальные): в структуре ответа с полем `items` тип элементов массива должен быть явно задан (например, `TaskListItemDto`), а не обобщённый/пустой.

- **Проблема:** В OpenAPI для ответа списка заданий мог использоваться обобщённый `PaginatedResponseDto` с `items: array` без указания `items.$ref` на конкретную схему, из‑за чего в Swagger и в клиентском коде тип элементов не типизирован.
- **Требование:** В ответе POST /api/v1/report-6406/tasks/list (и везде, где возвращается пагинированный список) использовать DTO, в котором `items` типизирован как массив конкретной схемы, например `items: array of TaskListItemDto`.

### Проверка остальных респонсов

Проверить и при необходимости исправить все ответы, содержащие массивы, чтобы тип элементов был явно задан:

| Endpoint / ответ | Поле с массивом | Ожидаемый тип элементов | Примечание |
|------------------|-----------------|-------------------------|------------|
| POST /tasks/list | `items` | `TaskListItemDto` | Основной кейс; не подменять на обобщённый PaginatedResponseDto без типизации items |
| GET /packages/ (список пакетов) | `packages` | `PackageDto` | Уже отдельная схема PackagesListResponseDto |
| GET /tasks/{id}/files | `files` | `TaskFileDto` | TaskFilesResponseDto |
| GET /tasks/{id}/status-history | корень — массив | `StatusHistoryItemDto` | StatusHistoryResponseDto |
| Справочники (branches, report-types, currencies, formats, sources) | корень — массив | Соответствующий DTO (BranchDto и т.д.) | Уже типизированы в схемах |
| BulkDeleteTasksResponseDto, BulkCancelTasksResponseDto, StartTasksResponseDto | `results` | Соответствующий result-item schema | Проверить, что results не «any» |
| PackagesListResponseDto | `packages` | `PackageDto` | Уже типизирован |
| PackageDetailDto | `tasks` | `PackageTaskItemDto` (или аналог) | Уже типизирован |

Итог: убедиться, что в сгенерированной OpenAPI спецификации ни один ответ со списком не имеет массива с пустым/обобщённым `items`; везде указан `items.$ref` (или аналог) на конкретную схему элемента.

---

## Сравнение с заданиями TASK-010, TASK-011, TASK-012, TASK-013

Ниже — результат сопоставления замечаний TASK-014 с уже выполненными (010, 011, TASK-008) и запланированными (012, 013) заданиями.

### Уже исправлено

| № замечания | Что сделано | Где |
|-------------|-------------|-----|
| **1 (canCancel, canDelete, canStart)** | Поля добавлены в список заданий и детали; зафиксировано, что они определяются статусом. | TASK-011: TaskListItemDto и схемы заданий; в коде — `taskSchema`, `taskListItemSchema` |
| **3 (createdBy)** | `createdBy` сделан обязательным при ответе, не nullable; при создании проставляется на BE; для старых записей с null — подставлять пустую строку или согласованное значение. | TASK-011; в коде — `createdBy: z.string()` в `taskSchema` и `taskListItemSchema` |
| **4 (sortBy, пагинация)** | Вместо query-параметров используется тело запроса: `pagination` (number, size), `sorting` (direction, column), `filter`. Endpoint — POST /api/v1/report-6406/tasks/list. | TASK-010, TASK-011 |
| **2 (форматы размеров)** | Установлено хранение и передача размеров в байтах (number); типы и правила задокументированы. | TASK-008: размеры в байтах, bigint в БД, number в API; в схемах — `fileSize` (number \| null), `totalSize` (number) с описаниями |

**Конфликты требований** вынесены в отдельный документ: [api-6406-requirements-conflicts.md](./api-6406-requirements-conflicts.md).

### Можно спокойно исправить

| № замечания | Действие | Где править |
|-------------|----------|------------|
| **1 (currency при создании)** | Сделать поле `currency` опциональным в схеме создания задания (POST /tasks/). | `service2110/src/schemas/report-6406/tasks.schema.ts`: `createTaskSchema` — `currency: currencySchema.optional()` |
| **1 (source)** | Уточнить описание: ссылка на справочник / идентификатор источника данных. | Там же: `.describe('Ссылка на справочник или идентификатор источника данных')` для поля `source` |
| **5 (POST /tasks/cancel)** | Уточнить описание endpoint и статуса: на нашей стороне — «Задание отменено»; синхронизация с внешней системой может приводить к статусу KILLED_DAPP. | Описание операции отмены в OpenAPI (summary/description) и при необходимости описание enum-значения `killed_dapp` в схемах |
| **2 (fileSize \| null)** | При желании явно задокументировать семантику: «null = размер ещё не рассчитан» для заданий; для пакетов totalSize — всегда число (0 при пустом). | Описания полей в схемах (уже частично есть; при необходимости усилить формулировки) |
| **7 (accountSecondOrder)** | Переименовать поле `accountMaskSecondOrder` в `accountSecondOrder`, описание — «Счета второго порядка». | Схемы (createTaskSchema, taskSchema, taskDetailSchema), БД/сервисы, OpenAPI |
| **8 (конечные слеши)** | Привести все пути эндпоинтов к единому виду — без завершающего слеша. | Регистрация роутов, OpenAPI-спецификация, документация |

### Открытые вопросы (без конфликтов)

| Вопрос | Связь с другими задачами | Действие |
|--------|-------------------------|----------|
| **Разделение хранилища: корзина отчётов vs корзина ТФР** | Ни в TASK-010/011/012/013, ни в TASK-008 не решалось. | Зафиксировать в TASK-014 как продуктовый/архитектурный вопрос; решение — отдельно (владелец продукта или архитектор). |

**Задания на будущее** вынесены в отдельную задачу: [TASK-015-api-6406-follow-up.md](./TASK-015-api-6406-follow-up.md).

---

## Цели

- Уточнить контракт API по перечисленным пунктам (обязательность полей, форматы, названия статусов).
- Привести документацию и при необходимости реализацию в соответствие с замечаниями.
- Зафиксировать решения по открытым вопросам (createdBy, хранилище, пагинация/sortBy).
- **Типизация ответов со списками:** исправить response POST /api/v1/report-6406/tasks/list и проверить остальные респонсы — в пагинированных/списковых ответах поле `items` (и аналогичные массивы) должно быть типизировано конкретным DTO в OpenAPI, а не обобщённым «массив чего угодно».
- **Переименование:** `accountMaskSecondOrder` → `accountSecondOrder` (счета второго порядка) в схемах, ответах и БД.
- **Единообразие URL:** убрать конечные слеши у эндпоинтов; все пути — без завершающего слеша.
- **Фильтрация и сортировка:** сделать параметры фильтрации и колонку сортировки списка заданий детерминированными (строго заданные колонки, операторы, форматы значений).
