# TASK-005: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –≤ API —Ñ–æ—Ä–º—ã 6406

## –°—Ç–∞—Ç—É—Å
üìã –ë—ç–∫–ª–æ–≥

## –û–ø–∏—Å–∞–Ω–∏–µ
–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ API —Ñ–æ—Ä–º—ã –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏ 6406 –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ø–æ–ª–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –º–æ–¥—É–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç—å—é. –í–∫–ª—é—á–∞–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Å—Ç–∞—Ç—É—Å–Ω–æ–π –º–æ–¥–µ–ª–∏ —Å 21 —Å—Ç–∞—Ç—É—Å–æ–º, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞–º–∏ –æ—Ç—á—ë—Ç–æ–≤, –∏—Å—Ç–æ—Ä–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤, –≤—ã–≥—Ä—É–∑–∫—É —Ä–µ–µ—Å—Ç—Ä–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞.

## –¶–µ–ª–∏
1. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å–Ω—É—é –º–æ–¥–µ–ª—å –∑–∞–¥–∞–Ω–∏–π —Å 5 –¥–æ 21 —Å—Ç–∞—Ç—É—Å–∞
2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞–º–∏ –æ—Ç—á—ë—Ç–æ–≤
3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–¥–∞–Ω–∏–π
4. –î–æ–±–∞–≤–∏—Ç—å endpoint –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∑–∞–¥–∞–Ω–∏—è –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (BR-3)
5. –î–æ–±–∞–≤–∏—Ç—å endpoint –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏ —Ä–µ–µ—Å—Ç—Ä–∞ –æ—Ç—á—ë—Ç–æ–≤ –≤ CSV (BR-5)
6. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ–±—ä—ë–º–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
7. –î–æ–±–∞–≤–∏—Ç—å –±–∞–∑–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É —Ä–æ–ª–µ–π —á–µ—Ä–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ (–º–æ–∫–æ–≤—É—é)
8. –û–±–µ—Å–ø–µ—á–∏—Ç—å –ø–æ–ª–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤—Å–µ—Ö –±–∏–∑–Ω–µ—Å-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π (BR-1 –¥–æ BR-13)

## –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏ –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

### –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
- –û—Å–Ω–æ–≤–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç: `docs/rawData/2026-01-28/–ë–¢ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç.docx`
- –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è: TASK-003 (—É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞)
- API –∫–æ–Ω–≤–µ–Ω—Ü–∏–∏: `docs/api-conventions.md`

### –°–≤—è–∑—å —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ –∑–∞–¥–∞—á–∞–º–∏
- **TASK-002**: –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ Backend (–≤—ã–ø–æ–ª–Ω–µ–Ω–æ)
- **TASK-003**: –ü–µ—Ä–≤–∏—á–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è API —Ñ–æ—Ä–º—ã 6406 (–≤—ã–ø–æ–ª–Ω–µ–Ω–æ) - 5 –±–∞–∑–æ–≤—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤
- **TASK-005**: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–æ –ø–æ–ª–Ω–æ–≥–æ –æ–±—ä—ë–º–∞ (—Ç–µ–∫—É—â–∞—è –∑–∞–¥–∞—á–∞)

## –ù–æ–≤–∞—è —Å—Ç–∞—Ç—É—Å–Ω–∞—è –º–æ–¥–µ–ª—å (21 —Å—Ç–∞—Ç—É—Å)

### –°—Ç–∞—Ç—É—Å—ã –¥–ª—è DAPP (Data Application Processing)

–°—Ç–∞—Ç—É—Å—ã —Å–≤—è–∑–∞–Ω—ã —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –¥–∞–Ω–Ω—ã—Ö –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –≤—ã–≥—Ä—É–∑–∫–∏:

| ‚Ññ | Code | Name (RU) | is_end_dapp | is_end_fc | –†–∞–∑—Ä–µ—à–µ–Ω–∞ –æ—Ç–º–µ–Ω–∞ | –†–∞–∑—Ä–µ—à–µ–Ω–æ —É–¥–∞–ª–µ–Ω–∏–µ | –†–∞–∑—Ä–µ—à–µ–Ω –∑–∞–ø—É—Å–∫ |
|---|------|-----------|-------------|-----------|------------------|-------------------|-----------------|
| 1 | upload_generation | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤—ã–≥—Ä—É–∑–∫–∏ | false | false | true | false | false |
| 2 | registered | –ó–∞–¥–∞–Ω–∏–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ | false | false | true | false | false |
| 3 | failed | –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤—ã–≥—Ä—É–∑–∫–∏ | true | false | false | true | false |
| 4 | upload_not_formed | –í—ã–≥—Ä—É–∑–∫–∞ –Ω–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∞ | true | false | false | true | false |
| 5 | upload_formed | –í—ã–≥—Ä—É–∑–∫–∞ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∞ | true | false | true | false | false |
| 6 | accepted_dapp | –ó–∞–¥–∞–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ –∫ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—é | false | false | true | false | false |
| 7 | submitted_dapp | –ó–∞–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –≤ –æ—á–µ—Ä–µ–¥—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è | false | false | true | false | false |
| 8 | killed_dapp | –ó–∞–¥–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ | true | false | true | true | false |
| 9 | new_dapp | –ó–∞–¥–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ | false | false | true | false | false |
| 10 | saving_dapp | –ó–∞–¥–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ | false | false | true | false | false |

### –°—Ç–∞—Ç—É—Å—ã –¥–ª—è File Conversion (FC)

–°—Ç–∞—Ç—É—Å—ã —Å–≤—è–∑–∞–Ω—ã —Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π —Ñ–∞–π–ª–æ–≤:

| ‚Ññ | Code | Name (RU) | is_end_dapp | is_end_fc | –†–∞–∑—Ä–µ—à–µ–Ω–∞ –æ—Ç–º–µ–Ω–∞ | –†–∞–∑—Ä–µ—à–µ–Ω–æ —É–¥–∞–ª–µ–Ω–∏–µ | –†–∞–∑—Ä–µ—à–µ–Ω –∑–∞–ø—É—Å–∫ |
|---|------|-----------|-------------|-----------|------------------|-------------------|-----------------|
| 11 | created | –°–æ–∑–¥–∞–Ω –æ—Ç—á–µ—Ç | false | false | false | true | true |
| 12 | deleted | –û—Ç—á–µ—Ç —É–¥–∞–ª–µ–Ω | false | false | false | false | false |
| 13 | started | –û—Ç—á–µ—Ç –∑–∞–ø—É—â–µ–Ω | false | false | true | false | false |
| 14 | start_failed | –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –æ—Ç—á–µ—Ç–∞ | false | false | false | true | false |
| 15 | converting | –û—Ç—á–µ—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è | false | false | true | false | false |
| 16 | completed | –†–∞–±–æ—Ç–∞ –Ω–∞–¥ –æ—Ç—á–µ—Ç–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (—Ñ–∞–π–ª—ã —Å–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã) | false | true | false | true | false |
| 17 | convert_stopped | –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ | - | - | - | true | false |
| 18 | in_queue | –§–∞–π–ª—ã –æ—Ç—á–µ—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –æ—á–µ—Ä–µ–¥—å –Ω–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é | false | true | true | false | false |
| 19 | file_success_not_exist | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ñ–∞–π–ª _SUCCESS –≤ –ø–∞–ø–∫–µ –æ—Ç—á–µ—Ç–∞ | false | true | false | true | false |
| 20 | failed_fc | –û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Ñ–∞–π–ª–∞ | false | true | false | true | false |
| 21 | have_broken_files | –ï—Å—Ç—å —Ñ–∞–π–ª—ã —Å –æ—à–∏–±–∫–æ–π –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ | false | true | false | true | false |

### –ü—Ä–∞–≤–∏–ª–∞ —Å—Ç–∞—Ç—É—Å–Ω–æ–π –º–æ–¥–µ–ª–∏

1. **–£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ**, –µ—Å–ª–∏ –æ—Ç—á–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–∞–±–æ—Ç—ã (–ø–æ–ª–µ `–†–∞–∑—Ä–µ—à–µ–Ω–æ —É–¥–∞–ª–µ–Ω–∏–µ` = false)
2. **–û—Ç–º–µ–Ω–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–∞**, –µ—Å–ª–∏ —Ä–∞–±–æ—Ç–∞ —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∏–ª–∏ –ø—Ä–µ—Ä–≤–∞–Ω–∞ –æ—à–∏–±–∫–æ–π (–ø–æ–ª–µ `–†–∞–∑—Ä–µ—à–µ–Ω–∞ –æ—Ç–º–µ–Ω–∞` = false)
3. **–ó–∞–ø—É—Å–∫ —Ä–∞–∑—Ä–µ—à—ë–Ω** —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ —Å –ø–æ–ª–µ–º `–†–∞–∑—Ä–µ—à–µ–Ω –∑–∞–ø—É—Å–∫` = true (currently —Ç–æ–ª—å–∫–æ `created`)

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è —Å—Ç–∞—Ç—É—Å–Ω–æ–π –º–æ–¥–µ–ª–∏

–ö —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü–µ `report_6406_tasks` –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è:
- `is_end_dapp` (boolean) - –ø—Ä–∏–∑–Ω–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ DAPP
- `is_end_fc` (boolean) - –ø—Ä–∏–∑–Ω–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Ñ–∞–π–ª–æ–≤
- `can_cancel` (boolean) - —Ä–∞–∑—Ä–µ—à–µ–Ω–∞ –ª–∏ –æ—Ç–º–µ–Ω–∞ –∑–∞–¥–∞–Ω–∏—è
- `can_delete` (boolean) - —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è
- `can_start` (boolean) - —Ä–∞–∑—Ä–µ—à–µ–Ω –ª–∏ –∑–∞–ø—É—Å–∫ –∑–∞–¥–∞–Ω–∏—è

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**: –≠—Ç–∏ –ø–æ–ª—è —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ —Å–æ–≥–ª–∞—Å–Ω–æ —Ç–∞–±–ª–∏—Ü–µ –≤—ã—à–µ.

## –î–æ–º–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å (–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –∫ TASK-003)

### 1. –ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–¥–∞–Ω–∏—è (ReportTaskStatusHistory)

–ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–¥–∞–Ω–∏–π.

**–ü–æ–ª—è:**
- `id` (UUID) - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏ –∏—Å—Ç–æ—Ä–∏–∏
- `taskId` (UUID, FK) - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–¥–∞–Ω–∏—è
- `status` (enum) - —Å—Ç–∞—Ç—É—Å (–æ–¥–∏–Ω –∏–∑ 21 —Å—Ç–∞—Ç—É—Å–∞)
- `previousStatus` (enum, nullable) - –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å—Ç–∞—Ç—É—Å
- `changedAt` (timestamp) - –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
- `changedBy` (string, nullable) - –∫—Ç–æ –∏–∑–º–µ–Ω–∏–ª (–§–ò–û –∏–ª–∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
- `comment` (text, nullable) - –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—é
- `metadata` (jsonb, nullable) - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏—á–∏–Ω–∞ –æ—à–∏–±–∫–∏)

**–°–≤—è–∑–∏:**
- –°–≤—è–∑–∞–Ω–∞ —Å —Ç–∞–±–ª–∏—Ü–µ–π `report_6406_tasks` —á–µ—Ä–µ–∑ `taskId`

**–ò–Ω–¥–µ–∫—Å—ã:**
- `idx_status_history_task_id` –Ω–∞ –ø–æ–ª–µ `taskId`
- `idx_status_history_changed_at` –Ω–∞ –ø–æ–ª–µ `changedAt DESC`

### 2. –§–∞–π–ª—ã –æ—Ç—á—ë—Ç–∞ (ReportTaskFile)

–ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–∞—Ö, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –∑–∞–¥–∞–Ω–∏–µ–º.

**–ü–æ–ª—è:**
- `id` (UUID) - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ñ–∞–π–ª–∞
- `taskId` (UUID, FK) - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–¥–∞–Ω–∏—è
- `fileName` (string) - –∏–º—è —Ñ–∞–π–ª–∞
- `fileSize` (bigint) - —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –≤ –±–∞–π—Ç–∞—Ö
- `fileType` (string) - —Ç–∏–ø —Ñ–∞–π–ª–∞ (mime-type)
- `status` (enum) - —Å—Ç–∞—Ç—É—Å —Ñ–∞–π–ª–∞:
  - `PENDING` - –æ–∂–∏–¥–∞–µ—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
  - `CONVERTING` - –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è
  - `COMPLETED` - –≥–æ—Ç–æ–≤
  - `FAILED` - –æ—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
- `storageUrl` (string) - URL —Ñ–∞–π–ª–∞ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (S3 –∏–ª–∏ –∞–Ω–∞–ª–æ–≥)
- `downloadUrl` (string, nullable) - pre-signed URL –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø–æ –∑–∞–ø—Ä–æ—Å—É)
- `downloadUrlExpiresAt` (timestamp, nullable) - –≤—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è pre-signed URL
- `errorMessage` (text, nullable) - —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ (–µ—Å–ª–∏ status = FAILED)
- `createdAt` (timestamp) - –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞
- `updatedAt` (timestamp) - –¥–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

**–°–≤—è–∑–∏:**
- –°–≤—è–∑–∞–Ω–∞ —Å —Ç–∞–±–ª–∏—Ü–µ–π `report_6406_tasks` —á–µ—Ä–µ–∑ `taskId`

**–ò–Ω–¥–µ–∫—Å—ã:**
- `idx_task_files_task_id` –Ω–∞ –ø–æ–ª–µ `taskId`
- `idx_task_files_status` –Ω–∞ –ø–æ–ª–µ `status`

### 3. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –∑–∞–¥–∞–Ω–∏—è (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ ReportTask)

–ö —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü–µ `report_6406_tasks` –¥–æ–±–∞–≤–∏—Ç—å:
- `createdBy` (string) - –§–ò–û –∏–ª–∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–æ–∑–¥–∞—Ç–µ–ª—è –∑–∞–¥–∞–Ω–∏—è
- `lastStatusChangedAt` (timestamp) - –¥–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
- `startedAt` (timestamp, nullable) - –¥–∞—Ç–∞ –∑–∞–ø—É—Å–∫–∞ –∑–∞–¥–∞–Ω–∏—è –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
- `completedAt` (timestamp, nullable) - –¥–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è
- `filesCount` (integer, default: 0) - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ –≤ –∑–∞–¥–∞–Ω–∏–∏ (–¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è)

## API Endpoints (–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –∫ TASK-003)

**–í–∞–∂–Ω–æ**: –í—Å–µ endpoints –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å –ø—Ä–µ—Ñ–∏–∫—Å–∞ `/api/v1/report-6406`

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è–º–∏ (—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ)

#### POST /api/v1/report-6406/tasks/start
–ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–¥–Ω–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–¥–∞–Ω–∏–π –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (BR-3).

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ü–µ—Ä–µ–≤–æ–¥–∏—Ç –∑–∞–¥–∞–Ω–∏—è –∏–∑ —Å—Ç–∞—Ç—É—Å–∞ `created` –≤ —Å—Ç–∞—Ç—É—Å `started` –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–æ–≤. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–ø—É—Å–∫ –∫–∞–∫ –æ–¥–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è, —Ç–∞–∫ –∏ –º–∞—Å—Å–æ–≤—ã–π –∑–∞–ø—É—Å–∫.

**–ó–∞–≥–æ–ª–æ–≤–∫–∏:**
- `X-User-Role` (string, optional) - —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (user, manager, admin)
- `X-User-Name` (string, optional) - –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

**Request Body:**
```json
{
  "taskIds": [
    "03cb0f48-1234-5678-9abc-def012345678",
    "03cb0f48-1234-5678-9abc-def012345679"
  ]
}
```

**Validation:**
- `taskIds` - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ, –º–∞—Å—Å–∏–≤ UUID, –º–∏–Ω–∏–º—É–º 1 —ç–ª–µ–º–µ–Ω—Ç
- –í—Å–µ –∑–∞–¥–∞–Ω–∏—è –¥–æ–ª–∂–Ω—ã —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å
- –ó–∞–¥–∞–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ —Å—Ç–∞—Ç—É—Å–µ `created` (–º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è)
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –≤—Å–µ—Ö –∑–∞–¥–∞–Ω–∏–π (—Å–º. –ª–∏–º–∏—Ç—ã –Ω–∏–∂–µ)

**Response 200 (–ø–æ–ª–Ω—ã–π —É—Å–ø–µ—Ö):**
```json
{
  "started": 2,
  "failed": 0,
  "results": [
    {
      "taskId": "03cb0f48-1234-5678-9abc-def012345678",
      "status": "started",
      "startedAt": "2026-01-28T12:00:00Z"
    },
    {
      "taskId": "03cb0f48-1234-5678-9abc-def012345679",
      "status": "started",
      "startedAt": "2026-01-28T12:00:00Z"
    }
  ],
  "errors": []
}
```

**Response 200 (—á–∞—Å—Ç–∏—á–Ω—ã–π —É—Å–ø–µ—Ö):**
```json
{
  "started": 1,
  "failed": 1,
  "results": [
    {
      "taskId": "03cb0f48-1234-5678-9abc-def012345678",
      "status": "started",
      "startedAt": "2026-01-28T12:00:00Z"
    }
  ],
  "errors": [
    {
      "taskId": "03cb0f48-1234-5678-9abc-def012345679",
      "reason": "Cannot start task in 'completed' status. Only tasks with status 'created' can be started"
    }
  ]
}
```

**Response 507 Insufficient Storage:**
```json
{
  "type": "https://tools.ietf.org/html/rfc7231#section-6.6.8",
  "title": "Insufficient Storage",
  "status": 507,
  "detail": "Not enough storage space. Required: 200MB, Available: 50MB"
}
```

#### GET /api/v1/report-6406/tasks/:id
–ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–¥–∞–Ω–∏–∏ (–æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π endpoint –∏–∑ TASK-003).

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å TASK-003:**
- –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è: `createdBy`, `lastStatusChangedAt`, `startedAt`, `completedAt`, `filesCount`
- –î–æ–±–∞–≤–∏—Ç—å –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ –ø–æ–ª—è: `canCancel`, `canDelete`, `canStart` (–Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞)
- –ü–æ–ª–µ `status` —Ç–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å –æ–¥–∏–Ω –∏–∑ 21 —Å—Ç–∞—Ç—É—Å–∞

**Response 200:**
```json
{
  "id": "03cb0f48-1234-5678-9abc-def012345678",
  "createdAt": "2025-11-11T17:22:10Z",
  "createdBy": "–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á",
  "branchId": 7701,
  "branchName": "–§–∏–ª–∏–∞–ª ‚Ññ 7701 –ë–∞–Ω–∫–∞ –í–¢–ë (–ø—É–±–ª–∏—á–Ω–æ–µ –∞–∫—Ü–∏–æ–Ω–µ—Ä–Ω–æ–µ –æ–±—â–µ—Å—Ç–≤–æ)",
  "periodStart": "2000-01-01",
  "periodEnd": "2030-12-31",
  "accountMask": "40817",
  "accountMaskSecondOrder": "01",
  "currency": "RUB",
  "format": "TXT",
  "reportType": "LSOZ",
  "source": "SRC001",
  "status": "completed",
  "canCancel": false,
  "canDelete": true,
  "canStart": false,
  "fileSize": 34603008,
  "filesCount": 3,
  "fileUrl": "https://storage.example.com/reports/03cb0f48-1234-5678-9abc-def012345678.txt",
  "errorMessage": null,
  "lastStatusChangedAt": "2025-11-11T17:25:30Z",
  "startedAt": "2025-11-11T17:22:15Z",
  "completedAt": "2025-11-11T17:25:30Z",
  "updatedAt": "2025-11-11T17:25:30Z",
  "packages": [
    {
      "id": "12312341451-uuid",
      "name": "–ö–∞–∫–æ–µ-—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–∞",
      "addedAt": "2025-11-11T18:00:00Z"
    }
  ]
}
```

### –ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–¥–∞–Ω–∏—è (BR-10)

#### GET /api/v1/report-6406/tasks/:id/status-history
–ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–¥–∞–Ω–∏—è.

**Path Parameters:**
- `id` (UUID) - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–¥–∞–Ω–∏—è

**Query Parameters:**
- `page` (integer, default: 0) - –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- `limit` (integer, default: 20, max: 100) - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ

**Response 200:**
```json
{
  "taskId": "03cb0f48-1234-5678-9abc-def012345678",
  "history": [
    {
      "id": "hist-001",
      "status": "completed",
      "previousStatus": "converting",
      "changedAt": "2025-11-11T17:25:30Z",
      "changedBy": "System",
      "comment": "All files converted successfully"
    },
    {
      "id": "hist-002",
      "status": "converting",
      "previousStatus": "started",
      "changedAt": "2025-11-11T17:23:00Z",
      "changedBy": "System",
      "comment": null
    },
    {
      "id": "hist-003",
      "status": "started",
      "previousStatus": "created",
      "changedAt": "2025-11-11T17:22:15Z",
      "changedBy": "–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á",
      "comment": "Manually started by user"
    },
    {
      "id": "hist-004",
      "status": "created",
      "previousStatus": null,
      "changedAt": "2025-11-11T17:22:10Z",
      "changedBy": "–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á",
      "comment": "Task created"
    }
  ],
  "pagination": {
    "page": 0,
    "limit": 20,
    "totalItems": 4,
    "totalPages": 1
  }
}
```

### –§–∞–π–ª—ã –æ—Ç—á—ë—Ç–∞ (BR-12, BR-13)

#### GET /api/v1/report-6406/tasks/:id/files
–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –∑–∞–¥–∞–Ω–∏—è.

**Path Parameters:**
- `id` (UUID) - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–¥–∞–Ω–∏—è

**Query Parameters:**
- `page` (integer, default: 0) - –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- `limit` (integer, default: 20, max: 100) - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
- `sortBy` (string, default: 'status') - –ø–æ–ª–µ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ ['status', 'fileName', 'fileSize', 'createdAt']
- `sortOrder` (string, default: 'ASC') - –ø–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ ['ASC', 'DESC']
- `status` (string[], optional) - —Ñ–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º —Ñ–∞–π–ª–æ–≤

**Response 200:**
```json
{
  "taskId": "03cb0f48-1234-5678-9abc-def012345678",
  "files": [
    {
      "id": "file-001",
      "fileName": "report_part_1.txt",
      "fileSize": 10485760,
      "fileType": "text/plain",
      "status": "COMPLETED",
      "downloadUrl": "https://storage.example.com/presigned/file-001?expires=...",
      "downloadUrlExpiresAt": "2026-01-28T13:00:00Z",
      "errorMessage": null,
      "createdAt": "2025-11-11T17:23:00Z",
      "updatedAt": "2025-11-11T17:25:00Z"
    },
    {
      "id": "file-002",
      "fileName": "report_part_2.txt",
      "fileSize": 12582912,
      "fileType": "text/plain",
      "status": "FAILED",
      "downloadUrl": null,
      "downloadUrlExpiresAt": null,
      "errorMessage": "Conversion failed: Invalid file format",
      "createdAt": "2025-11-11T17:23:00Z",
      "updatedAt": "2025-11-11T17:24:00Z"
    }
  ],
  "pagination": {
    "page": 0,
    "limit": 20,
    "totalItems": 2,
    "totalPages": 1
  }
}
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –æ downloadUrl:**
- Pre-signed URL –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤
- –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: 1 —á–∞—Å —Å –º–æ–º–µ–Ω—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- –î–ª—è –º–æ–∫–æ–≤–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏: –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π URL —Å —Ç–µ–∫—Å—Ç–æ–≤—ã–º —Ñ–∞–π–ª–æ–º

#### POST /api/v1/report-6406/tasks/:taskId/files/:fileId/retry
‚ö†Ô∏è **–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª** - –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é —Ñ–∞–π–ª–∞ —Å –æ—à–∏–±–∫–æ–π.

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**: –≠—Ç–æ—Ç endpoint —è–≤–ª—è–µ—Ç—Å—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–º –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–º–µ–Ω—ë–Ω –∏–ª–∏ —É–¥–∞–ª—ë–Ω –≤ –±—É–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞.

**Path Parameters:**
- `taskId` (UUID) - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–¥–∞–Ω–∏—è
- `fileId` (UUID) - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ñ–∞–π–ª–∞

**Validation:**
- –§–∞–π–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Å—Ç–∞—Ç—É—Å–µ `FAILED`

**Response 200:**
```json
{
  "id": "file-002",
  "status": "PENDING",
  "message": "File conversion restarted"
}
```

**Response 501 Not Implemented (–¥–ª—è –ø–µ—Ä–≤–æ–π –≤–µ—Ä—Å–∏–∏):**
```json
{
  "type": "https://tools.ietf.org/html/rfc7231#section-6.6.2",
  "title": "Not Implemented",
  "status": 501,
  "detail": "File retry functionality is not implemented yet. This is an experimental feature."
}
```

### –í—ã–≥—Ä—É–∑–∫–∞ —Ä–µ–µ—Å—Ç—Ä–∞ –æ—Ç—á—ë—Ç–æ–≤ (BR-5)

#### POST /api/v1/report-6406/tasks/export
–í—ã–≥—Ä—É–∑–∏—Ç—å —Ä–µ–µ—Å—Ç—Ä –æ—Ç—á—ë—Ç–æ–≤ –≤ CSV —Ñ–æ—Ä–º–∞—Ç–µ.

**Request Body:**
```json
{
  "filters": {
    "status": ["completed", "failed"],
    "branchId": 7701,
    "periodStartFrom": "2025-01-01",
    "periodStartTo": "2025-12-31"
  },
  "sortBy": "createdAt",
  "sortOrder": "DESC"
}
```

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–°–æ–∑–¥–∞—ë—Ç CSV —Ñ–∞–π–ª —Å–æ —Å–ø–∏—Å–∫–æ–º –∑–∞–¥–∞–Ω–∏–π —Å–æ–≥–ª–∞—Å–Ω–æ —Ñ–∏–ª—å—Ç—Ä–∞–º. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞.

**Response 200:**
```json
{
  "exportId": "export-12345",
  "status": "COMPLETED",
  "fileUrl": "https://storage.example.com/exports/report-6406-tasks-export-12345.csv",
  "fileSize": 1048576,
  "downloadUrlExpiresAt": "2026-01-28T13:00:00Z",
  "recordsCount": 1523,
  "createdAt": "2026-01-28T12:00:00Z"
}
```

**CSV —Ñ–æ—Ä–º–∞—Ç:**
```csv
ID,Created At,Created By,Branch ID,Branch Name,Period Start,Period End,Status,File Size,Format,Report Type,Started At,Completed At
03cb0f48-1234-5678-9abc-def012345678,2025-11-11T17:22:10Z,–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á,7701,–§–∏–ª–∏–∞–ª ‚Ññ 7701,2000-01-01,2030-12-31,completed,34603008,TXT,LSOZ,2025-11-11T17:22:15Z,2025-11-11T17:25:30Z
...
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –¥–ª—è –º–æ–∫–æ–≤–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**
- –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å CSV "–Ω–∞ –ª–µ—Ç—É" –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ CSV (–Ω–∞–ø—Ä–∏–º–µ—Ä, `csv-stringify`)
- –í–æ–∑–≤—Ä–∞—â–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ dynamically generated file –∏–ª–∏ stream

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞

#### GET /api/v1/report-6406/storage/volume
–ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–Ω—è—Ç–æ–º –∏ —Å–≤–æ–±–æ–¥–Ω–æ–º –æ–±—ä—ë–º–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞.

**Response 200:**
```json
{
  "totalBytes": 1099511627776,
  "usedBytes": 549755813888,
  "freeBytes": 549755813888,
  "usedPercent": 50.0,
  "totalHuman": "1.00 TB",
  "usedHuman": "512.00 GB",
  "freeHuman": "512.00 GB",
  "warning": null
}
```

**Response 200 (—Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º –æ –Ω–µ—Ö–≤–∞—Ç–∫–µ –º–µ—Å—Ç–∞):**
```json
{
  "totalBytes": 1099511627776,
  "usedBytes": 989626271129,
  "freeBytes": 109885356646,
  "usedPercent": 90.0,
  "totalHuman": "1.00 TB",
  "usedHuman": "921.60 GB",
  "freeHuman": "102.40 GB",
  "warning": "Storage usage is above 85%. Consider cleaning up old reports."
}
```

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (ENV):**
- `STORAGE_MAX_SIZE_BYTES` - –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –æ–±—ä—ë–º —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –≤ –±–∞–π—Ç–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 1099511627776 = 1TB)
- `STORAGE_WARNING_THRESHOLD` - –ø–æ—Ä–æ–≥ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 85)

**–õ–æ–≥–∏–∫–∞ —Ä–∞—Å—á—ë—Ç–∞:**
- `usedBytes` = —Å—É–º–º–∞ –≤—Å–µ—Ö `fileSize` –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `report_6406_tasks` –≥–¥–µ `status` != 'deleted'
- `freeBytes` = `totalBytes` - `usedBytes`
- `usedPercent` = (`usedBytes` / `totalBytes`) * 100
- `warning` –ø–æ—è–≤–ª—è–µ—Ç—Å—è, –µ—Å–ª–∏ `usedPercent` >= `STORAGE_WARNING_THRESHOLD`

### –õ–∏–º–∏—Ç—ã —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (BR-3)

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∑–∞–¥–∞–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—è—Ç—å –Ω–∞–ª–∏—á–∏–µ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞:
1. –ü–æ–ª—É—á–∏—Ç—å –æ–∂–∏–¥–∞–µ–º—ã–π —Ä–∞–∑–º–µ—Ä –æ—Ç—á—ë—Ç–∞ (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–∫–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä 100MB)
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: `freeBytes` >= `expectedReportSize`
3. –ï—Å–ª–∏ –º–µ—Å—Ç–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É 507 Insufficient Storage

## –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è)

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã report_6406_tasks

```sql
ALTER TABLE report_6406_tasks
  -- –ù–æ–≤—ã–µ —Å—Ç–∞—Ç—É—Å—ã (–æ–±–Ω–æ–≤–∏—Ç—å CHECK constraint)
  DROP CONSTRAINT IF EXISTS report_6406_tasks_status_check,
  ADD CONSTRAINT report_6406_tasks_status_check CHECK (
    status IN (
      'upload_generation', 'registered', 'failed', 'upload_not_formed', 'upload_formed',
      'accepted_dapp', 'submitted_dapp', 'killed_dapp', 'new_dapp', 'saving_dapp',
      'created', 'deleted', 'started', 'start_failed', 'converting',
      'completed', 'convert_stopped', 'in_queue', 'file_success_not_exist',
      'failed_fc', 'have_broken_files'
    )
  ),
  
  -- –ù–æ–≤—ã–µ –ø–æ–ª—è
  ADD COLUMN created_by VARCHAR(255),
  ADD COLUMN last_status_changed_at TIMESTAMP DEFAULT NOW(),
  ADD COLUMN started_at TIMESTAMP,
  ADD COLUMN completed_at TIMESTAMP,
  ADD COLUMN files_count INTEGER DEFAULT 0;

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE INDEX idx_report_6406_tasks_created_by ON report_6406_tasks(created_by);
CREATE INDEX idx_report_6406_tasks_last_status_changed_at ON report_6406_tasks(last_status_changed_at DESC);
```

### –¢–∞–±–ª–∏—Ü–∞: report_6406_task_status_history

```sql
CREATE TABLE report_6406_task_status_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  task_id UUID NOT NULL REFERENCES report_6406_tasks(id) ON DELETE CASCADE,
  status VARCHAR(30) NOT NULL CHECK (
    status IN (
      'upload_generation', 'registered', 'failed', 'upload_not_formed', 'upload_formed',
      'accepted_dapp', 'submitted_dapp', 'killed_dapp', 'new_dapp', 'saving_dapp',
      'created', 'deleted', 'started', 'start_failed', 'converting',
      'completed', 'convert_stopped', 'in_queue', 'file_success_not_exist',
      'failed_fc', 'have_broken_files'
    )
  ),
  previous_status VARCHAR(30),
  changed_at TIMESTAMP NOT NULL DEFAULT NOW(),
  changed_by VARCHAR(255),
  comment TEXT,
  metadata JSONB,
  created_at TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_status_history_task_id ON report_6406_task_status_history(task_id);
CREATE INDEX idx_status_history_changed_at ON report_6406_task_status_history(changed_at DESC);
```

### –¢–∞–±–ª–∏—Ü–∞: report_6406_task_files

```sql
CREATE TABLE report_6406_task_files (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  task_id UUID NOT NULL REFERENCES report_6406_tasks(id) ON DELETE CASCADE,
  file_name VARCHAR(255) NOT NULL,
  file_size BIGINT NOT NULL,
  file_type VARCHAR(100) NOT NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'PENDING' CHECK (status IN ('PENDING', 'CONVERTING', 'COMPLETED', 'FAILED')),
  storage_url TEXT NOT NULL,
  download_url TEXT,
  download_url_expires_at TIMESTAMP,
  error_message TEXT,
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_task_files_task_id ON report_6406_task_files(task_id);
CREATE INDEX idx_task_files_status ON report_6406_task_files(status);
CREATE INDEX idx_task_files_created_at ON report_6406_task_files(created_at DESC);
```

## –°–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π (–º–æ–∫–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)

### –†–æ–ª–∏
- `user` - –±–∞–∑–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–æ–ø–µ—Ä–∞—Ç–æ—Ä –±–∞–Ω–∫–∞)
- `manager` - –º–µ–Ω–µ–¥–∂–µ—Ä (–∫–æ–Ω—Ç—Ä–æ–ª—ë—Ä)
- `admin` - –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä

### –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- `X-User-Role` (string, optional) - —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 'user')
- `X-User-Name` (string, optional) - –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 'Anonymous User')
- `X-User-Id` (string, optional) - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 'anonymous')

### Middleware –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ

```typescript
// src/plugins/user-context.ts
import type { FastifyPluginAsync } from 'fastify';

export interface UserContext {
  role: 'user' | 'manager' | 'admin';
  name: string;
  id: string;
}

declare module 'fastify' {
  interface FastifyRequest {
    user: UserContext;
  }
}

export const userContextPlugin: FastifyPluginAsync = async (fastify) => {
  fastify.decorateRequest('user', null);

  fastify.addHook('onRequest', async (request) => {
    const role = (request.headers['x-user-role'] as string) || 'user';
    const name = (request.headers['x-user-name'] as string) || 'Anonymous User';
    const id = (request.headers['x-user-id'] as string) || 'anonymous';

    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–æ–ª–∏
    if (!['user', 'manager', 'admin'].includes(role)) {
      throw new Error(`Invalid role: ${role}`);
    }

    request.user = {
      role: role as 'user' | 'manager' | 'admin',
      name,
      id,
    };
  });
};
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö

```typescript
// –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏—è
const task = await createTask({
  ...data,
  createdBy: request.user.name, // –ò–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ X-User-Name
});

// –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
await addStatusHistory({
  taskId,
  status: newStatus,
  previousStatus: currentStatus,
  changedBy: request.user.name,
});
```

### –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ
**–í–∞–∂–Ω–æ**: –≠—Ç–æ —É–ø—Ä–æ—â—ë–Ω–Ω–∞—è –º–æ–∫–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏. –ù–∞—Å—Ç–æ—è—â–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ JWT –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –±—É–¥—É—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –∑–∞–¥–∞—á–µ.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ (–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è)

```
/be/src
  /db/schema
    report-6406-tasks.schema.ts          # –û–±–Ω–æ–≤–∏—Ç—å: –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Å—Ç–∞—Ç—É—Å—ã –∏ –ø–æ–ª—è
    report-6406-task-status-history.schema.ts  # –ù–æ–≤–∞—è —Å—Ö–µ–º–∞
    report-6406-task-files.schema.ts     # –ù–æ–≤–∞—è —Å—Ö–µ–º–∞
    index.ts                             # –û–±–Ω–æ–≤–∏—Ç—å: –¥–æ–±–∞–≤–∏—Ç—å —ç–∫—Å–ø–æ—Ä—Ç –Ω–æ–≤—ã—Ö —Å—Ö–µ–º
    
  /routes/v1/report-6406
    /tasks
      index.ts                           # –û–±–Ω–æ–≤–∏—Ç—å: –¥–æ–±–∞–≤–∏—Ç—å POST /:id/start
      bulk-operations.ts                 # –û–±–Ω–æ–≤–∏—Ç—å: –¥–æ–±–∞–≤–∏—Ç—å bulk-start
      status-history.ts                  # –ù–æ–≤—ã–π —Ñ–∞–π–ª: –∏—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤
      files.ts                           # –ù–æ–≤—ã–π —Ñ–∞–π–ª: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞–º–∏
      export.ts                          # –ù–æ–≤—ã–π —Ñ–∞–π–ª: –≤—ã–≥—Ä—É–∑–∫–∞ —Ä–µ–µ—Å—Ç—Ä–∞
    /storage
      index.ts                           # –ù–æ–≤—ã–π —Ñ–∞–π–ª: –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
      
  /services/report-6406
    tasks.service.ts                     # –û–±–Ω–æ–≤–∏—Ç—å: –¥–æ–±–∞–≤–∏—Ç—å startTask, updateStatus
    task-status-history.service.ts       # –ù–æ–≤—ã–π —Ñ–∞–π–ª: —Ä–∞–±–æ—Ç–∞ —Å –∏—Å—Ç–æ—Ä–∏–µ–π —Å—Ç–∞—Ç—É—Å–æ–≤
    task-files.service.ts                # –ù–æ–≤—ã–π —Ñ–∞–π–ª: —Ä–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏
    export.service.ts                    # –ù–æ–≤—ã–π —Ñ–∞–π–ª: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è CSV
    storage.service.ts                   # –ù–æ–≤—ã–π —Ñ–∞–π–ª: —Ä–∞—Å—á—ë—Ç –æ–±—ä—ë–º–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
    
  /schemas/report-6406
    tasks.schema.ts                      # –û–±–Ω–æ–≤–∏—Ç—å: –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è –∏ —Å—Ç–∞—Ç—É—Å—ã
    task-status-history.schema.ts        # –ù–æ–≤—ã–π —Ñ–∞–π–ª: —Å—Ö–µ–º—ã –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
    task-files.schema.ts                 # –ù–æ–≤—ã–π —Ñ–∞–π–ª: —Å—Ö–µ–º—ã –¥–ª—è —Ñ–∞–π–ª–æ–≤
    export.schema.ts                     # –ù–æ–≤—ã–π —Ñ–∞–π–ª: —Å—Ö–µ–º—ã –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
    storage.schema.ts                    # –ù–æ–≤—ã–π —Ñ–∞–π–ª: —Å—Ö–µ–º—ã –¥–ª—è —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
    
  /plugins
    user-context.ts                      # –ù–æ–≤—ã–π —Ñ–∞–π–ª: middleware –¥–ª—è user context
    
  /types
    status-model.ts                      # –ù–æ–≤—ã–π —Ñ–∞–π–ª: —Ç–∏–ø—ã –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã —Å—Ç–∞—Ç—É—Å–æ–≤
    
  /utils
    file-size-formatter.ts               # –ù–æ–≤—ã–π —Ñ–∞–π–ª: —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–≤ (bytes to human)
    presigned-url-generator.ts           # –ù–æ–≤—ã–π —Ñ–∞–π–ª: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –º–æ–∫–æ–≤—ã—Ö pre-signed URLs
    csv-generator.ts                     # –ù–æ–≤—ã–π —Ñ–∞–π–ª: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è CSV —Ñ–∞–π–ª–æ–≤
```

## –ë–∏–∑–Ω–µ—Å-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è (Business Requirements)

### –ú–æ–¥—É–ª—å ¬´–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–º –∑–∞–¥–∞–Ω–∏–π¬ª

#### BR-1: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ TASK-003
- Endpoint: `POST /api/v1/report-6406/tasks`

#### BR-2: –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ TASK-003, –æ–±–Ω–æ–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é
- Endpoint: `DELETE /api/v1/report-6406/tasks/:id`
- –û–±–Ω–æ–≤–∏—Ç—å: –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–ª–µ `can_delete` –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç—É—Å–∞
- –ü—Ä–∞–≤–∏–ª–æ: –Ω–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ —Å `can_delete = false`

#### BR-3: –ó–∞–ø—É—Å–∫ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–æ–≤
**–°—Ç–∞—Ç—É—Å**: üÜï –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- Endpoint: `POST /api/v1/report-6406/tasks/start` (–µ–¥–∏–Ω—ã–π endpoint –¥–ª—è –æ–¥–Ω–æ–≥–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∑–∞–¥–∞–Ω–∏–π)
- –ü—Ä–æ–≤–µ—Ä–∫–∞: —Å—Ç–∞—Ç—É—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `created`
- –ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω–∞–ª–∏—á–∏–µ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ

#### BR-4: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ TASK-003
- Endpoint: `GET /api/v1/report-6406/tasks?status=...&branchId=...`
- –û–±–Ω–æ–≤–∏—Ç—å: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–æ–≤—ã—Ö 21 —Å—Ç–∞—Ç—É—Å–æ–≤ –≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ö

#### BR-5: –í—ã–≥—Ä—É–∑–∫–∞ —Ä–µ–µ—Å—Ç—Ä–∞ –æ—Ç—á–µ—Ç–æ–≤
**–°—Ç–∞—Ç—É—Å**: üÜï –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- Endpoint: `POST /api/v1/report-6406/tasks/export`
- –§–æ—Ä–º–∞—Ç: CSV
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–µ–º –∂–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º —á—Ç–æ –∏ GET —Å–ø–∏—Å–∫–∞

#### BR-6: –û—Ç–º–µ–Ω–∞ –∑–∞–ø—É—Å–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–æ–≤
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ TASK-003, –æ–±–Ω–æ–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é
- Endpoint: `POST /api/v1/report-6406/tasks/:id/cancel`
- –û–±–Ω–æ–≤–∏—Ç—å: –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–ª–µ `can_cancel` –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç—É—Å–∞
- –ü—Ä–∞–≤–∏–ª–æ: –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ —Å `can_cancel = false`

#### BR-7: –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ –æ—Ç—á–µ—Ç–æ–≤
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ TASK-003
- Endpoint: `GET /api/v1/report-6406/tasks`
- –û–±–Ω–æ–≤–∏—Ç—å: –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è –≤ response

#### BR-8: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞–º–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ TASK-003
- Query –ø–∞—Ä–∞–º–µ—Ç—Ä `limit` –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è —Ä–∞–∑–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

#### BR-9: –ü–∞–≥–∏–Ω–∞—Ü–∏—è
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ TASK-003
- Query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã `page` –∏ `limit`

### –ú–æ–¥—É–ª—å ¬´–ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –æ—Ç—á–µ—Ç–∞¬ª

#### BR-10: –ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Å—Ç–æ—Ä–∏–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ –æ—Ç—á–µ—Ç–∞
**–°—Ç–∞—Ç—É—Å**: üÜï –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- Endpoint: `GET /api/v1/report-6406/tasks/:id/status-history`
- –¢–∞–±–ª–∏—Ü–∞: `report_6406_task_status_history`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å–æ–≤

### –ú–æ–¥—É–ª—å ¬´–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞¬ª

#### BR-11: –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ –æ—Ç—á–µ—Ç—É
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ TASK-003, —Ä–∞—Å—à–∏—Ä–∏—Ç—å response
- Endpoint: `GET /api/v1/report-6406/tasks/:id`
- –î–æ–±–∞–≤–∏—Ç—å: –Ω–æ–≤—ã–µ –ø–æ–ª—è (`createdBy`, `filesCount`, `startedAt`, `completedAt`)
- –î–æ–±–∞–≤–∏—Ç—å: –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ –ø–æ–ª—è (`canCancel`, `canDelete`, `canStart`)

### –ú–æ–¥—É–ª—å ¬´–§–∞–π–ª—ã –æ—Ç—á–µ—Ç–∞¬ª

#### BR-12: –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤ –æ—Ç—á–µ—Ç–∞
**–°—Ç–∞—Ç—É—Å**: üÜï –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- Endpoint: `GET /api/v1/report-6406/tasks/:id/files`
- –¢–∞–±–ª–∏—Ü–∞: `report_6406_task_files`
- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å—É (—Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —É—Å–ø–µ—à–Ω—ã–µ —Å–≤–µ—Ä—Ö—É, –ø–æ—Å–ª–µ —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –Ω–µ—É—Å–ø–µ—à–Ω—ã–µ, –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏)

#### BR-13: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
**–°—Ç–∞—Ç—É—Å**: üÜï –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- Pre-signed URLs –≤ response –æ—Ç `GET /api/v1/report-6406/tasks/:id/files`
- –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ñ–∞–π–ª–æ–≤ –≤ —Å—Ç–∞—Ç—É—Å–µ `COMPLETED`
- –ú–æ–∫–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è: —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π URL –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª —Å —Å–æ–¥–µ—Ä–∂–∏–º—ã–º "Mock report file content"

## –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–Ω—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤

```typescript
// src/services/report-6406/tasks.service.ts
export class TasksService {
  private getStatusPermissions(status: TaskStatus) {
    const permissions = STATUS_PERMISSIONS_MAP[status];
    return {
      canCancel: permissions.canCancel,
      canDelete: permissions.canDelete,
      canStart: permissions.canStart,
    };
  }

  async startTask(taskId: string, userId: string): Promise<Task> {
    const task = await this.getTaskById(taskId);
    
    if (!task) {
      throw new NotFoundError(`Task with id '${taskId}' not found`);
    }

    const permissions = this.getStatusPermissions(task.status);
    
    if (!permissions.canStart) {
      throw new ConflictError(
        `Cannot start task in '${task.status}' status. Only tasks with status 'created' can be started`
      );
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –º–µ—Å—Ç–∞ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
    const storageInfo = await storageService.getStorageVolume();
    const estimatedSize = 104857600; // 100MB mock value
    
    if (storageInfo.freeBytes < estimatedSize) {
      throw new InsufficientStorageError(
        `Not enough storage space. Required: ${formatBytes(estimatedSize)}, Available: ${formatBytes(storageInfo.freeBytes)}`
      );
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
    const updatedTask = await this.updateTaskStatus(
      taskId,
      'started',
      task.status,
      userId,
      'Task started by user'
    );

    return updatedTask;
  }

  async updateTaskStatus(
    taskId: string,
    newStatus: TaskStatus,
    previousStatus: TaskStatus,
    changedBy: string,
    comment?: string
  ): Promise<Task> {
    // –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è: –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ + –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é
    return await db.transaction(async (trx) => {
      // –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ
      const task = await trx
        .update(tasks)
        .set({
          status: newStatus,
          lastStatusChangedAt: new Date(),
          updatedAt: new Date(),
          // –û–±–Ω–æ–≤–∏—Ç—å startedAt –µ—Å–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥ –≤ started
          ...(newStatus === 'started' && { startedAt: new Date() }),
          // –û–±–Ω–æ–≤–∏—Ç—å completedAt –µ—Å–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥ –≤ completed
          ...(newStatus === 'completed' && { completedAt: new Date() }),
        })
        .where(eq(tasks.id, taskId))
        .returning();

      // –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é
      await trx.insert(taskStatusHistory).values({
        taskId,
        status: newStatus,
        previousStatus,
        changedAt: new Date(),
        changedBy,
        comment,
      });

      return task[0];
    });
  }
}
```

### HTTP —Å—Ç–∞—Ç—É—Å-–∫–æ–¥—ã

- `200 OK` - —É—Å–ø–µ—à–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- `201 Created` - —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞
- `204 No Content` - —É—Å–ø–µ—à–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
- `400 Bad Request` - –æ—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- `404 Not Found` - —Ä–µ—Å—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω
- `409 Conflict` - –∫–æ–Ω—Ñ–ª–∏–∫—Ç –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ–ª—å–∑—è –∑–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Å—Ç–∞—Ç—É—Å–µ)
- `507 Insufficient Storage` - –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ

### –§–æ—Ä–º–∞—Ç –æ—à–∏–±–æ–∫ (RFC 7807)

```json
{
  "type": "https://tools.ietf.org/html/rfc7231#section-6.6.8",
  "title": "Insufficient Storage",
  "status": 507,
  "detail": "Not enough storage space. Required: 100MB, Available: 50MB"
}
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (Environment Variables)

–î–æ–±–∞–≤–∏—Ç—å –≤ `.env.example`:

```env
# Storage Configuration
STORAGE_MAX_SIZE_BYTES=1099511627776  # 1TB
STORAGE_WARNING_THRESHOLD=85          # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ 85% –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è

# File URLs (Mock)
MOCK_FILE_STORAGE_URL=http://localhost:3000/mock-files
PRESIGNED_URL_EXPIRATION_HOURS=1     # –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è pre-signed URLs

# CSV Export
CSV_EXPORT_MAX_RECORDS=10000         # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ CSV
```

## –ú–æ–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ —Ñ—É–Ω–∫—Ü–∏–∏

### –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–æ–∫–æ–≤—ã—Ö pre-signed URLs

```typescript
// src/utils/presigned-url-generator.ts
import { env } from '../config/env.js';

export function generateMockPresignedUrl(fileId: string, fileName: string): {
  url: string;
  expiresAt: Date;
} {
  const baseUrl = env.MOCK_FILE_STORAGE_URL || 'http://localhost:3000/mock-files';
  const expirationHours = env.PRESIGNED_URL_EXPIRATION_HOURS || 1;
  
  const url = `${baseUrl}/${fileId}/${encodeURIComponent(fileName)}`;
  const expiresAt = new Date();
  expiresAt.setHours(expiresAt.getHours() + expirationHours);
  
  return { url, expiresAt };
}
```

### Mock endpoint –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤

```typescript
// src/routes/mock-files.ts
import type { FastifyPluginAsync } from 'fastify';

export const mockFilesRoutes: FastifyPluginAsync = async (fastify) => {
  fastify.get('/mock-files/:fileId/:fileName', async (request, reply) => {
    const { fileId, fileName } = request.params as { fileId: string; fileName: string };
    
    const content = `Mock report file content
File ID: ${fileId}
File Name: ${fileName}
Generated at: ${new Date().toISOString()}

This is a mock file for development purposes.
In production, this would contain actual report data.`;

    return reply
      .header('Content-Type', 'text/plain; charset=utf-8')
      .header('Content-Disposition', `attachment; filename="${fileName}"`)
      .send(content);
  });
};
```

### –ú–æ–∫–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∑–∞–¥–∞–Ω–∏—è

```typescript
// src/services/report-6406/task-files.service.ts
export async function generateMockFilesForTask(taskId: string): Promise<void> {
  const mockFiles = [
    {
      taskId,
      fileName: 'report_part_1.txt',
      fileSize: 10485760, // 10MB
      fileType: 'text/plain',
      status: 'COMPLETED' as const,
      storageUrl: `s3://mock-bucket/reports/${taskId}/report_part_1.txt`,
    },
    {
      taskId,
      fileName: 'report_part_2.txt',
      fileSize: 12582912, // 12MB
      fileType: 'text/plain',
      status: 'COMPLETED' as const,
      storageUrl: `s3://mock-bucket/reports/${taskId}/report_part_2.txt`,
    },
    {
      taskId,
      fileName: 'report_summary.txt',
      fileSize: 1048576, // 1MB
      fileType: 'text/plain',
      status: 'COMPLETED' as const,
      storageUrl: `s3://mock-bucket/reports/${taskId}/report_summary.txt`,
    },
  ];

  await db.insert(taskFiles).values(mockFiles);
}
```

## –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `report_6406_tasks` —Å –Ω–æ–≤—ã–º–∏ –ø–æ–ª—è–º–∏ –∏ 21 —Å—Ç–∞—Ç—É—Å–æ–º
- [ ] –°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `report_6406_task_status_history`
- [ ] –°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `report_6406_task_files`
- [ ] –°–æ–∑–¥–∞–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–Ω–¥–µ–∫—Å—ã
- [ ] –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –º–∏–≥—Ä–∞—Ü–∏–∏

### API Endpoints - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è–º–∏ (–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è)
- [ ] POST /api/v1/report-6406/tasks/start - –∑–∞–ø—É—Å–∫ –∑–∞–¥–∞–Ω–∏—è (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–¥–Ω–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–¥–∞–Ω–∏–π)
- [ ] GET /api/v1/report-6406/tasks/:id - –æ–±–Ω–æ–≤–ª—ë–Ω —Å –Ω–æ–≤—ã–º–∏ –ø–æ–ª—è–º–∏
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è DELETE –∏ POST .../cancel

### API Endpoints - –ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤
- [ ] GET /api/v1/report-6406/tasks/:id/status-history - –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å–æ–≤

### API Endpoints - –§–∞–π–ª—ã
- [ ] GET /api/v1/report-6406/tasks/:id/files - —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ —Å pre-signed URLs
- [ ] POST /api/v1/report-6406/tasks/:taskId/files/:fileId/retry - –ø–æ–≤—Ç–æ—Ä –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ (‚ö†Ô∏è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π, –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å 501 Not Implemented)

### API Endpoints - –≠–∫—Å–ø–æ—Ä—Ç –∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
- [ ] POST /api/v1/report-6406/tasks/export - –≤—ã–≥—Ä—É–∑–∫–∞ —Ä–µ–µ—Å—Ç—Ä–∞ –≤ CSV
- [ ] GET /api/v1/report-6406/storage/volume - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞

### API Endpoints - Mock
- [ ] GET /mock-files/:fileId/:fileName - mock endpoint –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å–æ–≤ –≤ –∏—Å—Ç–æ—Ä–∏—é
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ (cancel, delete, start) –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç—É—Å–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∑–∞–¥–∞–Ω–∏—è
- [ ] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è pre-signed URLs –¥–ª—è —Ñ–∞–π–ª–æ–≤ (mock —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
- [ ] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è CSV —Ñ–∞–π–ª–∞ —Å —Ä–µ–µ—Å—Ç—Ä–æ–º –∑–∞–¥–∞–Ω–∏–π
- [ ] –ü–æ–¥—Å—á—ë—Ç –∑–∞–Ω—è—Ç–æ–≥–æ –∏ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
- [ ] Middleware –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤

### –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –º–µ–∂–¥—É —Å—Ç–∞—Ç—É—Å–∞–º–∏
- [ ] –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ 409 Conflict –ø—Ä–∏ –Ω–∞—Ä—É—à–µ–Ω–∏–∏ –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª
- [ ] –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ 507 Insufficient Storage
- [ ] –í—Å–µ endpoints –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ HTTP —Å—Ç–∞—Ç—É—Å-–∫–æ–¥—ã

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [ ] Swagger –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö endpoints
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤—Å–µ –Ω–æ–≤—ã–µ —Å—Ö–µ–º—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤
- [ ] –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è –≤—Å–µ—Ö endpoints
- [ ] –û–±–Ω–æ–≤–ª—ë–Ω —Ñ–∞–π–ª README.md —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –í—Å–µ –Ω–æ–≤—ã–µ endpoints –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ Swagger UI
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å—Ç–∞—Ç—É—Å–æ–≤
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è pre-signed URLs –¥–ª—è —Ñ–∞–π–ª–æ–≤
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è CSV —Ä–µ–µ—Å—Ç—Ä–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω –ø–æ–¥—Å—á—ë—Ç –æ–±—ä—ë–º–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞ middleware –¥–ª—è user context
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–Ω—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –¥–æ–ª–∂–Ω—ã –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:
```typescript
await db.transaction(async (trx) => {
  // 1. –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ
  await trx.update(tasks).set({ status: newStatus });
  
  // 2. –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é
  await trx.insert(taskStatusHistory).values({ ... });
});
```

### –î–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

–î–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—è:
- `filesCount` –≤ —Ç–∞–±–ª–∏—Ü–µ `report_6406_tasks` - –æ–±–Ω–æ–≤–ª—è—Ç—å –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏/—É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–æ–≤
- `usedBytes` –¥–ª—è —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ - —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—Ç—å –∫–∞–∫ —Å—É–º–º—É `fileSize` –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π

### –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–≤ —Ñ–∞–π–ª–æ–≤

```typescript
// src/utils/file-size-formatter.ts
export function formatBytes(bytes: number): string {
  const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
  if (bytes === 0) return '0 Bytes';
  const i = Math.floor(Math.log(bytes) / Math.log(1024));
  return `${(bytes / Math.pow(1024, i)).toFixed(2)} ${sizes[i]}`;
}
```

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è CSV

```typescript
// src/utils/csv-generator.ts
import { stringify } from 'csv-stringify/sync';

export function generateTasksCsv(tasks: Task[]): string {
  const records = tasks.map(task => ({
    'ID': task.id,
    'Created At': task.createdAt.toISOString(),
    'Created By': task.createdBy || '',
    'Branch ID': task.branchId,
    'Branch Name': task.branchName,
    'Period Start': task.periodStart,
    'Period End': task.periodEnd,
    'Status': task.status,
    'File Size': task.fileSize || 0,
    'Format': task.format,
    'Report Type': task.reportType,
    'Started At': task.startedAt?.toISOString() || '',
    'Completed At': task.completedAt?.toISOString() || '',
  }));

  return stringify(records, {
    header: true,
    columns: {
      'ID': 'ID',
      'Created At': 'Created At',
      'Created By': 'Created By',
      'Branch ID': 'Branch ID',
      'Branch Name': 'Branch Name',
      'Period Start': 'Period Start',
      'Period End': 'Period End',
      'Status': 'Status',
      'File Size': 'File Size',
      'Format': 'Format',
      'Report Type': 'Report Type',
      'Started At': 'Started At',
      'Completed At': 'Completed At',
    },
  });
}
```

## –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

1. –°–æ–∑–¥–∞—Ç—å –≤–µ—Ç–∫—É `feature/TASK-005-extend-6406-api-universal-report` –æ—Ç `main`
2. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**:
   - –û–±–Ω–æ–≤–∏—Ç—å Drizzle —Å—Ö–µ–º—É `report-6406-tasks.schema.ts` (–¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è –∏ 21 —Å—Ç–∞—Ç—É—Å)
   - –°–æ–∑–¥–∞—Ç—å Drizzle —Å—Ö–µ–º—É `report-6406-task-status-history.schema.ts`
   - –°–æ–∑–¥–∞—Ç—å Drizzle —Å—Ö–µ–º—É `report-6406-task-files.schema.ts`
   - –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
3. **–¢–∏–ø—ã –∏ —É—Ç–∏–ª–∏—Ç—ã**:
   - –°–æ–∑–¥–∞—Ç—å `src/types/status-model.ts` —Å –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞–º–∏ –∏ —Ç–∏–ø–∞–º–∏ –¥–ª—è 21 —Å—Ç–∞—Ç—É—Å–∞
   - –°–æ–∑–¥–∞—Ç—å `src/utils/file-size-formatter.ts`
   - –°–æ–∑–¥–∞—Ç—å `src/utils/presigned-url-generator.ts`
   - –°–æ–∑–¥–∞—Ç—å `src/utils/csv-generator.ts`
4. **Middleware**:
   - –°–æ–∑–¥–∞—Ç—å `src/plugins/user-context.ts`
   - –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–≥–∏–Ω –≤ `src/app.ts`
5. **Zod —Å—Ö–µ–º—ã**:
   - –û–±–Ω–æ–≤–∏—Ç—å `src/schemas/report-6406/tasks.schema.ts` (–Ω–æ–≤—ã–µ –ø–æ–ª—è)
   - –°–æ–∑–¥–∞—Ç—å `src/schemas/report-6406/task-status-history.schema.ts`
   - –°–æ–∑–¥–∞—Ç—å `src/schemas/report-6406/task-files.schema.ts`
   - –°–æ–∑–¥–∞—Ç—å `src/schemas/report-6406/export.schema.ts`
   - –°–æ–∑–¥–∞—Ç—å `src/schemas/report-6406/storage.schema.ts`
6. **–°–µ—Ä–≤–∏—Å—ã**:
   - –û–±–Ω–æ–≤–∏—Ç—å `src/services/report-6406/tasks.service.ts` (startTask, updateStatus)
   - –°–æ–∑–¥–∞—Ç—å `src/services/report-6406/task-status-history.service.ts`
   - –°–æ–∑–¥–∞—Ç—å `src/services/report-6406/task-files.service.ts`
   - –°–æ–∑–¥–∞—Ç—å `src/services/report-6406/export.service.ts`
   - –°–æ–∑–¥–∞—Ç—å `src/services/report-6406/storage.service.ts`
7. **–ú–∞—Ä—à—Ä—É—Ç—ã**:
   - –û–±–Ω–æ–≤–∏—Ç—å `src/routes/v1/report-6406/tasks/index.ts` (–¥–æ–±–∞–≤–∏—Ç—å POST /start)
   - –°–æ–∑–¥–∞—Ç—å `src/routes/v1/report-6406/tasks/status-history.ts`
   - –°–æ–∑–¥–∞—Ç—å `src/routes/v1/report-6406/tasks/files.ts`
   - –°–æ–∑–¥–∞—Ç—å `src/routes/v1/report-6406/tasks/export.ts`
   - –°–æ–∑–¥–∞—Ç—å `src/routes/v1/report-6406/storage/index.ts`
   - –°–æ–∑–¥–∞—Ç—å `src/routes/mock-files.ts`
   - –û–±–Ω–æ–≤–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –º–∞—Ä—à—Ä—É—Ç–æ–≤ –≤ `src/routes/v1/report-6406/index.ts`
8. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**:
   - –û–±–Ω–æ–≤–∏—Ç—å `src/config/env.ts` (–¥–æ–±–∞–≤–∏—Ç—å STORAGE_* –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ)
   - –û–±–Ω–æ–≤–∏—Ç—å `.env.example`
9. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**:
   - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –Ω–æ–≤—ã–µ endpoints —á–µ—Ä–µ–∑ Swagger UI
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é
10. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**:
    - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å Swagger –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
    - –û–±–Ω–æ–≤–∏—Ç—å README.md
11. –°–æ–∑–¥–∞—Ç—å –∫–æ–º–º–∏—Ç —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º: `TASK-005 –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –≤ API —Ñ–æ—Ä–º—ã 6406`

## –í–µ—Ç–∫–∞
`feature/TASK-005-extend-6406-api-universal-report`

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
- –ó–∞–≤–∏—Å–∏—Ç –æ—Ç: TASK-002 (–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Backend –ø—Ä–æ–µ–∫—Ç–∞) ‚úÖ
- –ó–∞–≤–∏—Å–∏—Ç –æ—Ç: TASK-003 (–†–µ–∞–ª–∏–∑–∞—Ü–∏—è API –¥–ª—è —Ñ–æ—Ä–º—ã –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏ 6406) ‚úÖ
- –°–ª–µ–¥—É—é—â–∞—è: TASK-006 (–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ RBAC) - –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –ø–æ–∑–∂–µ

## –°—Å—ã–ª–∫–∏
- –û—Å–Ω–æ–≤–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç: `docs/rawData/2026-01-28/–ë–¢ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç.docx`
- –°—Ç–∞—Ç—É—Å–Ω–∞—è –º–æ–¥–µ–ª—å: `docs/report-6406-status-model.md`
- API –∫–æ–Ω–≤–µ–Ω—Ü–∏–∏: `docs/api-conventions.md`
- –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è: `docs/tasks/TASK-003-implement-6406-report-api.md`
- Drizzle ORM: https://orm.drizzle.team/
- RFC 7807 Problem Details: https://tools.ietf.org/html/rfc7807
- CSV Stringify: https://csv.js.org/stringify/

## –í–æ–ø—Ä–æ—Å—ã —Ç—Ä–µ–±—É—é—â–∏–µ —É—Ç–æ—á–Ω–µ–Ω–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

**–í–∞–∂–Ω–æ**: –≠—Ç–∏ –≤–æ–ø—Ä–æ—Å—ã –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —É—Ç–æ—á–Ω–∏—Ç—å –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã –Ω–∞–¥ –∑–∞–¥–∞—á–µ–π:

### 1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤
–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∑–∞–¥–∞–Ω–∏—è (POST /api/v1/report-6406/tasks/start):
- –ù—É–∂–Ω–æ –ª–∏ —Å—Ä–∞–∑—É –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –º–æ–∫–æ–≤—ã–µ —Ñ–∞–π–ª—ã –≤ —Ç–∞–±–ª–∏—Ü–µ `report_6406_task_files`?
- –ò–ª–∏ —Ñ–∞–π–ª—ã –ø–æ—è–≤–ª—è—é—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (–∏–º–∏—Ç–∞—Ü–∏—è —Ñ–æ–Ω–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏)?

### 2. –°—Ç–∞—Ç—É—Å–Ω—ã–π —Ü–∏–∫–ª –∑–∞–¥–∞–Ω–∏—è
–ö–∞–∫–∏–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —Å—Ç–∞—Ç—É—Å–∞–º–∏ –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- `created` ‚Üí (POST /start) ‚Üí `started` ‚Üí ? ‚Üí `completed`
- –ù—É–∂–Ω–∞ –ª–∏ –∏–º–∏—Ç–∞—Ü–∏—è –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ (`converting`, `in_queue` –∏ —Ç.–¥.)?

### 3. CSV Export
- –î–æ–ª–∂–µ–Ω –ª–∏ endpoint `/tasks/export` –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Ñ–∞–π–ª —Å—Ä–∞–∑—É (stream) –∏–ª–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞–¥–∞—á—É –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é?
- –ï—Å–ª–∏ —Å–æ–∑–¥–∞—ë—Ç –∑–∞–¥–∞—á—É, –Ω—É–∂–Ω–∞ –ª–∏ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è export jobs?

## –£—Ç–æ—á–Ω–µ–Ω–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

_(–≠—Ç–∞ —Å–µ–∫—Ü–∏—è –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–∞–±–æ—Ç—ã –Ω–∞–¥ –∑–∞–¥–∞–Ω–∏–µ–º)_
