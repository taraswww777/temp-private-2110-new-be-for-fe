# TASK-007: Ключевые решения

## Дата: 2026-01-29

## Принятые решения

### 1. Status History (пункт 8)
**Решение:** Возвращать простой массив без пагинации

```typescript
GET /api/v1/report-6406/tasks/{id}/status-history
→ Array<StatusHistoryItem>
```

**Обоснование:**
- История изменений статусов обычно небольшая (десятки записей)
- Не требуется пагинация для такого объема
- Упрощается frontend код
- Можно сразу отобразить полную историю

---

### 2. Операция START (пункт 10)
**Решение:** Оставить как есть

```typescript
POST /api/v1/report-6406/tasks/start
Request: { "taskIds": ["uuid1", ...] }
```

**Обоснование:**
- Специфичная операция со сложной бизнес-логикой
- Проверка места в хранилище
- Запуск внешних процессов
- Текущий API интуитивен и функционален

---

### 3. HTTP статус для DELETE (пункт 13)
**Решение:** Использовать 200 OK с информативным телом (Вариант B)

```typescript
DELETE /api/v1/report-6406/tasks
Response: 200 OK
{
  "deleted": 5,
  "failed": 2,
  "results": [
    { "taskId": "uuid1", "success": true },
    { "taskId": "uuid2", "success": false, "reason": "..." }
  ]
}
```

**Обоснование:**
- Детальная информация об успехе каждой операции
- Критично для batch операций
- Поддержка частичного успеха
- Frontend может показать конкретные результаты пользователю

---

### 4. Naming для copy-to-tfr (пункт 14)
**Решение:** Оставить как есть с улучшенной документацией (Вариант B)

```typescript
POST /api/v1/report-6406/packages/{packageId}/copy-to-tfr
```

**Обоснование:**
- TFR - устоявшийся термин в предметной области
- Понятен бизнес-пользователям
- Полное название слишком длинное

**Требования:**
- Добавить в swagger: "Скопировать пакет в ТФР (Территориальный финансовый репозиторий)"
- Создать глоссарий терминов
- Добавить tooltip в UI

---

### 5. OpenAPI версия
**Решение:** Обновить до OpenAPI 3.1.0

```yaml
openapi: 3.1.0
info:
  version: 2.0.0  # новая мажорная версия API
```

**Преимущества:**
- Полная совместимость с JSON Schema 2020-12
- Современная экосистема инструментов
- Лучшая поддержка сложных типов
- Webhooks (на будущее)

**Изменения:**
- `nullable: true` → `anyOf: [{ type: 'string' }, { type: 'null' }]`
- Обновить @fastify/swagger >= 9.0.0

---

### 6. GraphQL
**Решение:** НЕ рассматриваем

**Обоснование:**
- REST API достаточно для текущих требований
- GraphQL требует дополнительной инфраструктуры
- Необходимо обучение команды
- Большие изменения в архитектуре
- Нет явной потребности в гибкой выборке данных

---

## Итоговая структура изменений

### Breaking Changes ✅
1. Reference endpoints → прямые массивы
2. DELETE операции → объединены в универсальные
3. CANCEL операции → объединены
4. Trailing slash → убран
5. Status history → простой массив (убрана пагинация)

### Non-Breaking Changes ✅
1. Фильтрация для GET /tasks
2. Pagination для GET /tasks/{id}/files
3. Схемы для status-history и export
4. Улучшенная документация
5. OpenAPI 3.1.0

### Без изменений ❌
1. START operation → остается как есть
2. copy-to-tfr → остается с улучшенной документацией
3. GraphQL → не рассматриваем

---

## Команда согласования

- [x] Техлид / Архитектор
- [ ] Backend разработчики
- [ ] Frontend разработчики
- [ ] QA
- [ ] Product Owner

---

## Следующие шаги

1. Обсудить план миграции с командой
2. Выбрать стратегию: Big Bang vs Gradual
3. Согласовать timeline с frontend командой
4. Начать реализацию Этапа 1
5. Параллельно подготовить миграцию на OpenAPI 3.1

---

**Дата утверждения:** 2026-01-29  
**Статус:** Утверждено  
**Следующий review:** После реализации Этапа 1
