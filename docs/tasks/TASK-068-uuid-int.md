# TASK‑068: Замена UUID на INT

**Статус**: ✅ Выполнено
**Ветка**: `feature/task‑068‑uuid‑int`  
**Приоритет**: средний

---

## Краткое описание

Полностью отказаться от использования UUID в схеме БД, заменив их на целочисленные идентификаторы (INT/BIGINT).

---

## Контекст

Текущий стек использует UUID для идентификации записей во всех таблицах. Это:

- увеличивает объём данных (16 байт vs 4–8 байт);
- усложняет отладку и ручное тестирование (неудобные для восприятия ID);
- может снижать производительность индексов.

Цель — перейти на INT/BIGINT для оптимизации хранения и скорости работы.

---

## Цели

- Заменить все столбцы типа UUID на INT/BIGINT.
- Обеспечить целостность данных при миграции.
- Сохранить работоспособность всех бизнес‑процессов.
- Минимизировать downtime при внедрении.

---

## Критерии приёмки

- Все таблицы используют INT/BIGINT вместо UUID в первичных ключах и внешних ссылках.
- Данные корректно мигрированы (нет потерь, все связи сохранены).
- Индексы пересозданы под новые типы.
- Все API и бизнес‑логика работают без ошибок.
- Тесты проходят успешно.
- Документация обновлена (схемы, API, инструкции).

---

## Технические заметки

- **Тип для новых ID**: использовать `BIGINT` (на случай большого объёма данных).
- **Генерация ID**: перейти на `SERIAL`/`IDENTITY` или sequence.
- **Внешние ключи**: обновить все FK‑связи после изменения первичных ключей.
- **Индексы**: пересоздать индексы, зависящие от UUID‑полей.
- **Приложения**: обновить ORM‑модели, DTO, валидаторы.
- **Миграция**: выполнить в рамках транзакции или с использованием временных таблиц.

---

## План выполнения

1. **Анализ зависимостей**
    - Выписать все таблицы с UUID‑ключами.
    - Определить цепочки внешних ключей.
    - Оценить объём данных для миграции.

   **Результат**:
    - Таблицы с UUID‑первичными
      ключами: `branches`, `sources`, `report_6406_tasks`, `report_6406_task_status_history`, `report_6406_task_files`, `report_6406_packages`, `report_6406_package_tasks`, `report_6406_task_branches`.
    - Цепочки внешних ключей:
        - `report_6406_tasks.branch_id` → `branches.id`
        - `report_6406_task_status_history.task_id` → `report_6406_tasks.id`
        - `report_6406_task_files.task_id` → `report_6406_tasks.id`
        - `report_6406_package_tasks.package_id` → `report_6406_packages.id`
        - `report_6406_package_tasks.task_id` → `report_6406_tasks.id`
        - `report_6406_task_branches.task_id` → `report_6406_tasks.id`
        - `report_6406_task_branches.branch_id` → `branches.id`


2. **Подготовка схемы**
    - Создать последовательности (`SEQUENCE`) для каждой таблицы.
    - Добавить новые столбцы `BIGINT` в таблицы (временно параллельно с UUID).
    - Настроить триггеры или логику для заполнения новых ID.

3. **Миграция данных**
    - Перенести данные из UUID в BIGINT с сохранением связей.
    - Проверить целостность связей после переноса.
    - Удалить старые UUID‑столбцы.

4. **Обновление ограничений и индексов**
    - Пересоздать первичные ключи на BIGINT.
    - Обновить внешние ключи.
    - Перестроить индексы.

5. **Изменение приложения**
    - Обновить ORM‑модели (например, JPA, Sequelize).
    - Изменить DTO и валидаторы.
    - Обновить SQL‑запросы в коде.
    - Проверить API‑контракты (если ID передаются в ответах).


6. **Тестирование**
    - Прогнать юнит‑тесты.
    - Проверить интеграционные сценарии (создание, обновление, удаление записей).
    - Протестировать нагрузку (сравнить производительность).


7. **Деплоймент**
    - Подготовить скрипт миграции для продакшена.
    - Запланировать окно простоя (если требуется).
    - Выполнить миграцию на продакшене.
    - Проверить логи и метрики после деплоя.


8. **Чистка и документация**
    - Удалить временные столбцы и триггеры.
    - Обновить документацию по схеме БД.
    - Описать изменения в CHANGELOG.

---

## Риски

- **Потеря данных**: резервное копирование перед миграцией.
- **Нарушение связей**: тщательная проверка FK после переноса.
- **Совместимость API**: убедиться, что клиенты готовы к изменению типа ID.
- **Производительность**: протестировать на копиях продакшен‑данных.

---

## Уточнения в процессе выполнения

- [Здесь будут добавляться уточнения, выявленные в процессе работы]
