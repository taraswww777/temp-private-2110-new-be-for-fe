# TASK-030: Поддержка множественных branchId в service2110

**Статус**: ✅ Выполнено  
**Ветка (основной репозиторий)**: `feature/TASK-030-service2110-multiple-branchId-support`  

---

## Краткое описание

В `temp-private-2110` (FE для формы 6406) реализован множественный выбор филиалов в поле `DepartmentField`.  
Сейчас при создании задания в API2 (`service2110`) используется только один `branchId` — берётся первый выбранный филиал.  
Нужно доработать `service2110`, чтобы он корректно поддерживал множественные `branchId` и согласовать это с текущим FE.

---

## Цели

- Обеспечить поддержку множественных `branchId` в `service2110` для формы 6406.
- Устранить временный workaround «используем первый выбранный филиал».
- Синхронизировать контракт API2 и FE.

---

## Детальное описание

1. **Анализ текущего контракта API2 (`service2110`)**:
   - Выяснить, какие эндпоинты и DTO используют поле `branchId` при создании и фильтрации заданий по форме 6406.
   - Зафиксировать текущее поведение (одиночный `branchId`).

2. **Проектирование поддержки множественных `branchId`**:
   - Предложить формат для передачи нескольких филиалов:
     - либо массив `branchIds: string[]`,
     - либо совместный вариант (одиночный `branchId` + массив `branchIds`) с бэксовместимостью.
   - Описать, как множественные филиалы должны отражаться:
     - в модели задачи (Task / TaskDetails / TaskListItem),
     - в фильтрах списков задач.

3. **Изменения в `service2110`**:
   - Обновить DTO и схемы (`CreateTaskDto`, фильтры списка задач и экспорта), чтобы поддерживать множественные филиалы.
   - Реализовать бизнес-логику работы с несколькими филиалами:
     - запись нескольких филиалов в хранилище,
     - корректная выборка/фильтрация.
   - Обновить Swagger-спеку и убедиться, что она корректно отражает новую модель.

4. **Согласование с FE (`temp-private-2110`)**:
   - Описать необходимые изменения в FE (отдельной задачей для фронта),
     чтобы:
     - передавать массив филиалов в API2,
     - корректно отображать задачи с несколькими филиалами.

---

## Критерии приёмки

- [x] В Swagger-документации `service2110` описана поддержка множественных `branchId` (создание и фильтрация задач).
- [x] DTO и модели в `service2110` позволяют задать несколько филиалов для одной задачи.
- [x] Логика сохранения и выборки корректно обрабатывает задачи с несколькими филиалами.
- [x] Задокументирован формат запроса, который должен использовать FE для работы с несколькими филиалами.
- [x] Описаны необходимые изменения для FE (но не реализованы в рамках данной задачи).

---

## Область изменений

| Файл / модуль | Описание |
|--------------|----------|
| `service2110` (модели и контроллеры создания/списка задач) | Добавление поддержки множественных `branchId` |
| Swagger-спека `service2110` | Обновление описания DTO и параметров фильтрации |

---

## Вне границ данной задачи

- Изменения в репозитории `temp-private-2110` (FE) — только формулировка требований и формат ожидаемого API.
- Любые изменения, не связанные с обработкой `branchId` / `branchIds` в `service2110`.

---

## Порядок выполнения

1. Проанализировать текущее использование `branchId` в `service2110`.
2. Спроектировать модель и формат передачи множественных филиалов.
3. Обновить DTO, модели и спецификацию Swagger.
4. Реализовать и покрыть тестами изменения в `service2110`.
5. Описать, как FE должен вызывать обновлённые эндпоинты.

---

## Уточнения в процессе выполнения

### Реализованный формат

1. **Создание задачи (`POST /api/v1/report-6406/tasks`)**:
   - Поддерживается как `branchId` (одиночный, для обратной совместимости), так и `branchIds` (массив)
   - Должен быть указан хотя бы один из них
   - Приоритет: если указан `branchIds`, используется он; иначе используется `branchId`
   - Пример запроса:
     ```json
     {
       "branchIds": ["uuid-1", "uuid-2", "uuid-3"],
       "periodStart": "2024-01-01",
       "periodEnd": "2024-01-31",
       "format": "XLSX",
       "reportType": "LSOZ"
     }
     ```

2. **Ответы API**:
   - Все DTO (TaskDto, TaskDetailsDto, TaskListItemDto) теперь содержат:
     - `branchId: string` — устаревшее поле (первый филиал для обратной совместимости)
     - `branchIds: string[]` — массив идентификаторов филиалов
     - `branchName: string` — устаревшее поле (название первого филиала)
     - `branchNames: string[]` — массив названий филиалов

3. **Фильтрация (`POST /api/v1/report-6406/tasks/list`)**:
   - Фильтр по `branchId` работает через таблицу связи `report_6406_task_branches`
   - Задача будет найдена, если она связана с указанным филиалом (даже если у неё есть другие филиалы)

4. **Экспорт (`POST /api/v1/report-6406/tasks/export`)**:
   - Фильтр `branchIds` работает через таблицу связи
   - Задачи будут найдены, если они связаны хотя бы с одним из указанных филиалов

### Изменения в базе данных

Создана таблица связи `report_6406_task_branches`:
- `task_id` — ссылка на задачу
- `branch_id` — ссылка на филиал
- Составной первичный ключ `(task_id, branch_id)`
- Индексы для оптимизации запросов

Поле `branchId` в таблице `report_6406_tasks` сохранено для обратной совместимости и содержит первый филиал.

### Требования для FE (`temp-private-2110`)

1. **При создании задачи**:
   - Использовать поле `branchIds` вместо `branchId`
   - Передавать массив всех выбранных филиалов:
     ```typescript
     const requestBody: API2.Service2110.CreateTaskDto = {
       branchIds: departmentIds, // массив UUID филиалов
       periodStart,
       periodEnd,
       format,
       reportType,
     };
     ```

2. **При отображении задач**:
   - Использовать `branchIds` и `branchNames` для отображения всех филиалов
   - Поле `branchId` и `branchName` можно игнорировать (оставлены для обратной совместимости)

3. **При фильтрации**:
   - Фильтр по `branchId` работает как раньше — находит задачи, связанные с указанным филиалом
   - Для фильтрации по нескольким филиалам можно использовать несколько фильтров `branchId` (логика ИЛИ)

### Примеры использования

**Создание задачи с несколькими филиалами:**
```typescript
POST /api/v1/report-6406/tasks
{
  "branchIds": ["550e8400-e29b-41d4-a716-446655440001", "550e8400-e29b-41d4-a716-446655440002"],
  "periodStart": "2024-01-01",
  "periodEnd": "2024-01-31",
  "format": "XLSX",
  "reportType": "LSOZ"
}
```

**Ответ:**
```json
{
  "id": "...",
  "branchId": "550e8400-e29b-41d4-a716-446655440001",
  "branchIds": ["550e8400-e29b-41d4-a716-446655440001", "550e8400-e29b-41d4-a716-446655440002"],
  "branchName": "Филиал 1",
  "branchNames": ["Филиал 1", "Филиал 2"],
  ...
}
```

